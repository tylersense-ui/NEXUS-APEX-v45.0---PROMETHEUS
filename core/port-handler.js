/**
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
 * â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
 * â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•
 *                           v45.0 - "Stealing Fire From The Gods"
 * 
 * @module      core/port-handler
 * @description Bus de communication inter-scripts sÃ©curisÃ© avec normalisation des retours,
 *              retry automatique et validation des schÃ©mas JSON.
 * @author      Claude (Anthropic) + tylersense-ui
 * @version     45.0 - PROMETHEUS
 * @date        2025-01-XX
 * @license     MIT
 * @requires    BitBurner v2.8.1+ (Steam)
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”¥ PROMETHEUS ENHANCEMENTS
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * âœ“ Normalisation des retours : null pour absence de donnÃ©es (plus de -1/"NULL PORT DATA")
 * âœ“ writeJSONWithRetry : retry automatique avec backoff exponentiel
 * âœ“ tryReadJSON : lecture non-bloquante pour polling
 * âœ“ Validation des schÃ©mas JSON (COMMANDS, STOCK_DATA)
 * âœ“ Logging robuste des erreurs de parsing JSON
 * âœ“ Try/catch autour de toutes les opÃ©rations
 * âœ“ Documentation exhaustive des formats de messages
 * âœ“ IcÃ´nes dans les logs (ğŸ“¨ğŸ“¥ğŸ“¤âŒâœ…)
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * @usage
 *   import { PortHandler } from "/core/port-handler.js";
 *   const ph = new PortHandler(ns);
 *   
 *   // Ã‰crire un objet
 *   ph.writeJSON(4, { type: 'hack', target: 'n00dles', threads: 10 });
 *   
 *   // Lire un objet
 *   const job = ph.readJSON(4);
 *   if (job) {
 *       ns.tprint(`Job reÃ§u: ${job.type} sur ${job.target}`);
 *   }
 * 
 * @example
 *   // Ã‰criture avec retry automatique
 *   const success = await ph.writeJSONWithRetry(4, { type: 'grow', target: 'joesguns' }, 5, 100);
 *   if (!success) {
 *       ns.tprint("âŒ Port 4 bloquÃ© aprÃ¨s 5 tentatives");
 *   }
 * 
 * @example
 *   // Lecture non-bloquante (peek)
 *   const data = ph.tryReadJSON(5);
 *   if (data) {
 *       ns.tprint(`ğŸ“Š DonnÃ©es boursiÃ¨res: ${data.value}`);
 *   } else {
 *       ns.tprint("Port 5 vide");
 *   }
 * 
 * @example
 *   // Validation de schÃ©ma
 *   const job = { type: 'hack', target: 'n00dles', threads: 10 };
 *   if (ph.validateCommandSchema(job)) {
 *       ph.writeJSON(4, job);
 *   }
 */

import { CONFIG } from "/lib/constants.js";

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ“˜ CLASSE PORTHANDLER
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Encapsulation des opÃ©rations sur les ports Netscript avec sÃ©curitÃ© et normalisation.
 * 
 * Les ports Netscript (1-20) sont des files FIFO pour la communication inter-scripts.
 * Chaque port peut stocker ~50 messages avant de bloquer les Ã©critures.
 * 
 * SchÃ©mas JSON supportÃ©s :
 * - COMMANDS (Port 4) : { type, host, target?, threads?, delay? }
 * - STOCK_DATA (Port 5) : { value, active }
 * - SHARE_RATIO (Port 6) : { shareRatio }
 */
export class PortHandler {
    /**
     * Constructeur du PortHandler
     * 
     * @param {NS} ns - Namespace BitBurner
     * 
     * @example
     *   const ph = new PortHandler(ns);
     */
    constructor(ns) {
        /** @type {NS} RÃ©fÃ©rence au namespace BitBurner */
        this.ns = ns;
        
        /**
         * Flag pour activer les logs de debug
         * DÃ©sactivÃ© par dÃ©faut pour Ã©viter le spam
         * @type {boolean}
         */
        this.debugMode = CONFIG.SYSTEM.DEBUG_MODE || false;
    }

    /**
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * ğŸ“¨ OPÃ‰RATIONS DE BASE (NormalisÃ©es)
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     */

    /**
     * ğŸ‘€ Peek (lecture sans consommer)
     * Regarde le prochain message sans le retirer du port.
     * 
     * PROMETHEUS: Normalise "NULL PORT DATA" en null
     * 
     * @public
     * @param {number} portId - NumÃ©ro du port (1-20)
     * @returns {string|null} Contenu du port ou null si vide
     * 
     * @example
     *   const nextMsg = ph.peek(4);
     *   if (nextMsg) {
     *       ns.tprint("Message en attente");
     *   }
     */
    peek(portId) {
        try {
            const data = this.ns.peek(portId);
            // Normalisation: "NULL PORT DATA" â†’ null
            return (data === "NULL PORT DATA") ? null : data;
        } catch (e) {
            if (this.debugMode) {
                this.ns.print(`âŒ Erreur peek sur port ${portId}: ${e.message}`);
            }
            return null;
        }
    }

    /**
     * ğŸ“¥ Read (lecture avec consommation)
     * Lit et retire le prochain message du port.
     * 
     * PROMETHEUS: Normalise -1 et "NULL PORT DATA" en null
     * 
     * @public
     * @param {number} portId - NumÃ©ro du port (1-20)
     * @returns {string|null} Contenu du port ou null si vide
     * 
     * @example
     *   const msg = ph.read(4);
     *   if (msg) {
     *       // Traiter le message
     *   }
     */
    read(portId) {
        try {
            const data = this.ns.readPort(portId);
            // Normalisation: -1 et "NULL PORT DATA" â†’ null
            if (data === -1 || data === "NULL PORT DATA") {
                return null;
            }
            return data;
        } catch (e) {
            if (this.debugMode) {
                this.ns.print(`âŒ Erreur read sur port ${portId}: ${e.message}`);
            }
            return null;
        }
    }

    /**
     * ğŸ“¤ Write (Ã©criture basique)
     * Ã‰crit un message sur le port.
     * Utilise tryWritePort pour Ã©viter les blocages si le port est plein.
     * 
     * @public
     * @param {number} portId - NumÃ©ro du port (1-20)
     * @param {any} data - DonnÃ©es Ã  Ã©crire
     * @returns {boolean} True si succÃ¨s, false si port plein
     * 
     * @example
     *   const success = ph.write(4, "Hello");
     *   if (!success) {
     *       ns.tprint("âŒ Port 4 plein");
     *   }
     */
    write(portId, data) {
        try {
            return this.ns.tryWritePort(portId, data);
        } catch (e) {
            if (this.debugMode) {
                this.ns.print(`âŒ Erreur write sur port ${portId}: ${e.message}`);
            }
            return false;
        }
    }

    /**
     * ğŸ—‘ï¸ Clear (vider le port)
     * Retire tous les messages du port.
     * 
     * @public
     * @param {number} portId - NumÃ©ro du port (1-20)
     * @returns {void}
     * 
     * @example
     *   ph.clear(4); // Vide complÃ¨tement le port 4
     */
    clear(portId) {
        try {
            this.ns.clearPort(portId);
        } catch (e) {
            if (this.debugMode) {
                this.ns.print(`âŒ Erreur clear sur port ${portId}: ${e.message}`);
            }
        }
    }

    /**
     * â“ IsEmpty (vÃ©rifier si vide)
     * VÃ©rifie si le port est vide.
     * 
     * @public
     * @param {number} portId - NumÃ©ro du port (1-20)
     * @returns {boolean} True si vide, false sinon
     * 
     * @example
     *   if (ph.isEmpty(4)) {
     *       ns.tprint("Port 4 vide");
     *   }
     */
    isEmpty(portId) {
        return this.peek(portId) === null;
    }

    /**
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * ğŸ“¦ OPÃ‰RATIONS JSON (SÃ©curisÃ©es)
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     */

    /**
     * ğŸ“¤ WriteJSON (Ã©criture d'objet)
     * SÃ©rialise un objet en JSON et l'Ã©crit sur le port.
     * 
     * @public
     * @param {number} portId - NumÃ©ro du port (1-20)
     * @param {Object} obj - Objet Ã  Ã©crire
     * @returns {boolean} True si succÃ¨s, false si Ã©chec
     * 
     * @example
     *   const success = ph.writeJSON(4, { type: 'hack', target: 'n00dles', threads: 10 });
     *   if (!success) {
     *       ns.tprint("âŒ Ã‰chec d'Ã©criture sur port 4");
     *   }
     */
    writeJSON(portId, obj) {
        try {
            const jsonStr = JSON.stringify(obj);
            const success = this.write(portId, jsonStr);
            
            if (this.debugMode && success) {
                this.ns.print(`âœ… WriteJSON sur port ${portId}: ${jsonStr.substring(0, 50)}...`);
            }
            
            return success;
        } catch (e) {
            this.ns.print(`âŒ Erreur writeJSON sur port ${portId}: ${e.message}`);
            return false;
        }
    }

    /**
     * ğŸ“¥ ReadJSON (lecture d'objet avec consommation)
     * Lit et parse un objet JSON du port.
     * 
     * PROMETHEUS: Log les erreurs de parsing et retourne null proprement
     * 
     * @public
     * @param {number} portId - NumÃ©ro du port (1-20)
     * @returns {Object|null} Objet parsÃ© ou null si erreur/vide
     * 
     * @example
     *   const job = ph.readJSON(4);
     *   if (job) {
     *       ns.tprint(`Type: ${job.type}, Target: ${job.target}`);
     *   }
     */
    readJSON(portId) {
        const data = this.read(portId);
        
        if (data === null) {
            return null;
        }

        try {
            const parsed = JSON.parse(data);
            
            if (this.debugMode) {
                this.ns.print(`âœ… ReadJSON sur port ${portId}: ${data.substring(0, 50)}...`);
            }
            
            return parsed;
        } catch (e) {
            // Log l'erreur de parsing (donnÃ©es corrompues)
            this.ns.print(`âŒ JSON invalide sur port ${portId}: ${data.substring(0, 100)}`);
            this.ns.print(`   Erreur: ${e.message}`);
            return null;
        }
    }

    /**
     * ğŸ‘€ TryReadJSON (lecture non-bloquante sans consommer)
     * Peek et parse un objet JSON sans le retirer du port.
     * Utile pour vÃ©rifier le contenu sans consommer.
     * 
     * PROMETHEUS: Nouvelle mÃ©thode pour polling non-bloquant
     * 
     * @public
     * @param {number} portId - NumÃ©ro du port (1-20)
     * @returns {Object|null} Objet parsÃ© ou null si erreur/vide
     * 
     * @example
     *   const stockData = ph.tryReadJSON(5);
     *   if (stockData) {
     *       ns.tprint(`Valeur bourse: ${stockData.value}`);
     *   }
     */
    tryReadJSON(portId) {
        const data = this.peek(portId);
        
        if (data === null) {
            return null;
        }

        try {
            return JSON.parse(data);
        } catch (e) {
            if (this.debugMode) {
                this.ns.print(`âŒ JSON invalide (peek) sur port ${portId}: ${e.message}`);
            }
            return null;
        }
    }

    /**
     * ğŸ”„ WriteJSONWithRetry (Ã©criture avec retry)
     * Tente d'Ã©crire un objet JSON avec retry automatique et backoff exponentiel.
     * 
     * PROMETHEUS: Nouvelle mÃ©thode pour fiabilitÃ© maximale
     * 
     * @public
     * @async
     * @param {number} portId - NumÃ©ro du port (1-20)
     * @param {Object} obj - Objet Ã  Ã©crire
     * @param {number} [maxRetries=5] - Nombre maximum de tentatives
     * @param {number} [baseDelay=50] - DÃ©lai de base en ms (doublÃ© Ã  chaque Ã©chec)
     * @returns {Promise<boolean>} True si succÃ¨s, false aprÃ¨s Ã©puisement des retries
     * 
     * @example
     *   const success = await ph.writeJSONWithRetry(4, { type: 'grow' }, 5, 100);
     *   if (!success) {
     *       ns.tprint("âŒ Port 4 dÃ©finitivement bloquÃ©");
     *   }
     */
    async writeJSONWithRetry(portId, obj, maxRetries = 5, baseDelay = 50) {
        let delay = baseDelay;
        
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            const success = this.writeJSON(portId, obj);
            
            if (success) {
                if (this.debugMode && attempt > 0) {
                    this.ns.print(`âœ… WriteJSON rÃ©ussi sur port ${portId} (tentative ${attempt + 1}/${maxRetries})`);
                }
                return true;
            }
            
            // Attendre avant de retry (backoff exponentiel)
            if (attempt < maxRetries - 1) {
                await this.ns.sleep(delay);
                delay *= 2; // Double le dÃ©lai Ã  chaque Ã©chec
            }
        }
        
        // Ã‰chec aprÃ¨s toutes les tentatives
        this.ns.print(`âŒ WriteJSON Ã©chouÃ© sur port ${portId} aprÃ¨s ${maxRetries} tentatives`);
        return false;
    }

    /**
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * âœ… VALIDATION DE SCHÃ‰MAS
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     */

    /**
     * Valide un objet de commande (Port 4)
     * 
     * SchÃ©ma COMMANDS:
     * {
     *   type: string (requis) - "hack", "grow", "weaken", "share"
     *   host: string (requis) - Serveur d'exÃ©cution
     *   target?: string (optionnel) - Serveur cible (pour hack/grow/weaken)
     *   threads?: number (optionnel) - Nombre de threads
     *   delay?: number (optionnel) - DÃ©lai en ms
     * }
     * 
     * @public
     * @param {Object} obj - Objet Ã  valider
     * @returns {boolean} True si valide, false sinon
     * 
     * @example
     *   const job = { type: 'hack', host: 'home', target: 'n00dles', threads: 10 };
     *   if (ph.validateCommandSchema(job)) {
     *       ph.writeJSON(4, job);
     *   }
     */
    validateCommandSchema(obj) {
        if (!obj || typeof obj !== 'object') {
            if (this.debugMode) {
                this.ns.print("âŒ SchÃ©ma COMMANDS invalide: pas un objet");
            }
            return false;
        }

        // Champs requis
        if (!obj.type || typeof obj.type !== 'string') {
            if (this.debugMode) {
                this.ns.print("âŒ SchÃ©ma COMMANDS invalide: 'type' manquant ou invalide");
            }
            return false;
        }

        if (!obj.host || typeof obj.host !== 'string') {
            if (this.debugMode) {
                this.ns.print("âŒ SchÃ©ma COMMANDS invalide: 'host' manquant ou invalide");
            }
            return false;
        }

        // Types valides
        const validTypes = ['hack', 'grow', 'weaken', 'share'];
        if (!validTypes.includes(obj.type)) {
            if (this.debugMode) {
                this.ns.print(`âŒ SchÃ©ma COMMANDS invalide: type '${obj.type}' non reconnu`);
            }
            return false;
        }

        // Validation des champs optionnels
        if (obj.threads !== undefined && (typeof obj.threads !== 'number' || obj.threads <= 0)) {
            if (this.debugMode) {
                this.ns.print("âŒ SchÃ©ma COMMANDS invalide: 'threads' doit Ãªtre un nombre > 0");
            }
            return false;
        }

        if (obj.delay !== undefined && (typeof obj.delay !== 'number' || obj.delay < 0)) {
            if (this.debugMode) {
                this.ns.print("âŒ SchÃ©ma COMMANDS invalide: 'delay' doit Ãªtre un nombre >= 0");
            }
            return false;
        }

        return true;
    }

    /**
     * Valide un objet de donnÃ©es boursiÃ¨res (Port 5)
     * 
     * SchÃ©ma STOCK_DATA:
     * {
     *   value: number (requis) - Valeur du portefeuille
     *   active: number (requis) - Nombre de positions actives
     * }
     * 
     * @public
     * @param {Object} obj - Objet Ã  valider
     * @returns {boolean} True si valide, false sinon
     * 
     * @example
     *   const stockData = { value: 1000000, active: 5 };
     *   if (ph.validateStockDataSchema(stockData)) {
     *       ph.writeJSON(5, stockData);
     *   }
     */
    validateStockDataSchema(obj) {
        if (!obj || typeof obj !== 'object') {
            if (this.debugMode) {
                this.ns.print("âŒ SchÃ©ma STOCK_DATA invalide: pas un objet");
            }
            return false;
        }

        if (typeof obj.value !== 'number' || obj.value < 0) {
            if (this.debugMode) {
                this.ns.print("âŒ SchÃ©ma STOCK_DATA invalide: 'value' manquant ou invalide");
            }
            return false;
        }

        if (typeof obj.active !== 'number' || obj.active < 0) {
            if (this.debugMode) {
                this.ns.print("âŒ SchÃ©ma STOCK_DATA invalide: 'active' manquant ou invalide");
            }
            return false;
        }

        return true;
    }

    /**
     * Valide un objet de ratio de partage (Port 6)
     * 
     * SchÃ©ma SHARE_RATIO:
     * {
     *   shareRatio: number (requis) - Ratio entre 0.0 et 1.0
     * }
     * 
     * @public
     * @param {Object} obj - Objet Ã  valider
     * @returns {boolean} True si valide, false sinon
     * 
     * @example
     *   const shareConfig = { shareRatio: 0.5 };
     *   if (ph.validateShareRatioSchema(shareConfig)) {
     *       ph.writeJSON(6, shareConfig);
     *   }
     */
    validateShareRatioSchema(obj) {
        if (!obj || typeof obj !== 'object') {
            if (this.debugMode) {
                this.ns.print("âŒ SchÃ©ma SHARE_RATIO invalide: pas un objet");
            }
            return false;
        }

        if (typeof obj.shareRatio !== 'number' || obj.shareRatio < 0 || obj.shareRatio > 1) {
            if (this.debugMode) {
                this.ns.print("âŒ SchÃ©ma SHARE_RATIO invalide: 'shareRatio' doit Ãªtre entre 0 et 1");
            }
            return false;
        }

        return true;
    }

    /**
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * ğŸ”§ UTILITAIRES
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     */

    /**
     * Active ou dÃ©sactive le mode debug
     * 
     * @public
     * @param {boolean} enabled - true pour activer, false pour dÃ©sactiver
     * @returns {void}
     * 
     * @example
     *   ph.setDebugMode(true);  // Active logs dÃ©taillÃ©s
     *   ph.setDebugMode(false); // DÃ©sactive logs
     */
    setDebugMode(enabled) {
        this.debugMode = enabled;
        this.ns.print(`ğŸ” PortHandler debug mode: ${enabled ? 'ACTIVÃ‰' : 'DÃ‰SACTIVÃ‰'}`);
    }

    /**
     * Affiche l'Ã©tat de tous les ports configurÃ©s
     * 
     * @public
     * @param {boolean} [useTPrint=false] - Si true, utilise tprint au lieu de print
     * @returns {void}
     * 
     * @example
     *   ph.printPortStatus();        // Dans tail
     *   ph.printPortStatus(true);    // Dans terminal
     */
    printPortStatus(useTPrint = false) {
        const print = useTPrint ? this.ns.tprint.bind(this.ns) : this.ns.print.bind(this.ns);
        
        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        print("ğŸ“¨ Ã‰TAT DES PORTS - NEXUS-APEX PROMETHEUS");
        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        
        for (const [name, portId] of Object.entries(CONFIG.PORTS)) {
            const isEmpty = this.isEmpty(portId);
            const status = isEmpty ? "ğŸŸ¢ VIDE" : "ğŸ”´ DONNÃ‰ES";
            
            print(`Port ${portId} (${name.padEnd(15)}): ${status}`);
            
            if (!isEmpty) {
                const data = this.peek(portId);
                const preview = String(data).substring(0, 50);
                print(`   Preview: ${preview}...`);
            }
        }
        
        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    }
}

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”¥ PROMETHEUS SIGNATURE
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
/** @param {NS} ns */
export async function main(ns) {
    ns.tprint("\x1b[38;5;196m");
    ns.tprint("    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—");
    ns.tprint("    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•");
    ns.tprint("    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—");
    ns.tprint("    â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘");
    ns.tprint("    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘");
    ns.tprint("    â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•");
    ns.tprint("                              v45.0 - \"Stealing Fire From The Gods\"");
    ns.tprint("\x1b[0m");
    ns.tprint("");
    
    // DÃ©monstration complÃ¨te du PortHandler
    const ph = new PortHandler(ns);
    ph.setDebugMode(true);
    
    ns.tprint("ğŸ“¨ DÃ©monstration PortHandler PROMETHEUS...");
    ns.tprint("");
    
    // Test 1: Ã‰criture/Lecture simple
    ns.tprint("ğŸ“¤ Test 1: Ã‰criture/Lecture JSON basique");
    const testObj = { type: 'hack', target: 'n00dles', threads: 10, delay: 0 };
    ph.writeJSON(4, testObj);
    const readObj = ph.readJSON(4);
    ns.tprint(`   Ã‰crit: ${JSON.stringify(testObj)}`);
    ns.tprint(`   Lu: ${JSON.stringify(readObj)}`);
    ns.tprint("");
    
    // Test 2: Validation de schÃ©ma
    ns.tprint("âœ… Test 2: Validation de schÃ©ma COMMANDS");
    const validJob = { type: 'grow', host: 'home', target: 'joesguns', threads: 50 };
    const invalidJob = { type: 'invalid', host: 123 }; // Invalide
    ns.tprint(`   Job valide: ${ph.validateCommandSchema(validJob)}`);
    ns.tprint(`   Job invalide: ${ph.validateCommandSchema(invalidJob)}`);
    ns.tprint("");
    
    // Test 3: WriteJSONWithRetry
    ns.tprint("ğŸ”„ Test 3: Ã‰criture avec retry");
    const success = await ph.writeJSONWithRetry(5, { value: 1000000, active: 3 }, 3, 50);
    ns.tprint(`   SuccÃ¨s aprÃ¨s retry: ${success}`);
    ns.tprint("");
    
    // Test 4: Ã‰tat des ports
    ns.tprint("ğŸ“Š Test 4: Ã‰tat de tous les ports");
    ph.printPortStatus(true);
    
    ns.tprint("");
    ns.tprint("âœ… DÃ©monstration terminÃ©e - PortHandler PROMETHEUS opÃ©rationnel");
}
