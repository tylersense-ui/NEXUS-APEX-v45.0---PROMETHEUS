/**
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
 * â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
 * â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•
 *                           v45.0 - "Stealing Fire From The Gods"
 * 
 * @module      core/orchestrator
 * @description Coordinateur gÃ©nÃ©ral du systÃ¨me PROMETHEUS - Initialise et orchestre
 *              tous les composants (Network, Batcher, Controller, etc.).
 * @author      Claude (Anthropic) + tylersense-ui
 * @version     45.0 - PROMETHEUS
 * @date        2025-01-XX
 * @license     MIT
 * @requires    BitBurner v2.8.1+ (Steam)
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”¥ PROMETHEUS ENHANCEMENTS
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * âœ“ Refresh interval configurable (CONFIG.ORCHESTRATOR.REFRESH_INTERVAL_MS)
 * âœ“ Try/catch robuste sur toutes les opÃ©rations
 * âœ“ Gestion gracieuse des erreurs (continue toujours)
 * âœ“ Support multi-cibles avec rotation
 * âœ“ MÃ©triques globales du systÃ¨me
 * âœ“ Crack automatique des nouveaux serveurs
 * âœ“ Logs dÃ©taillÃ©s avec icÃ´nes (ğŸ¼âœ…âŒâš ï¸ğŸ“Š)
 * âœ“ Banner ASCII au dÃ©marrage
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * @usage
 *   ns.run("/core/orchestrator.js");
 *   // L'orchestrator dÃ©marre automatiquement tout le systÃ¨me
 */

import { CONFIG } from "/lib/constants.js";
import { Logger } from "/lib/logger.js";
import { Capabilities } from "/lib/capabilities.js";
import { Network } from "/lib/network.js";
import { PortHandler } from "/core/port-handler.js";
import { RamManager } from "/core/ram-manager.js";
import { Batcher } from "/core/batcher.js";

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ¼ ORCHESTRATOR - MAIN FUNCTION
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Point d'entrÃ©e principal du systÃ¨me PROMETHEUS.
 * 
 * Workflow :
 * 1. Initialise tous les composants
 * 2. DÃ©marre le controller (dispatcher)
 * 3. Entre dans la boucle principale
 * 4. Refresh rÃ©seau pÃ©riodiquement
 * 5. SÃ©lectionne les meilleures cibles
 * 6. Dispatch des batchs via le Batcher
 * 7. RÃ©pÃ¨te indÃ©finiment
 * 
 * @param {NS} ns - Namespace BitBurner
 */
export async function main(ns) {
    // DÃ©sactiver les logs par dÃ©faut
    ns.disableLog("ALL");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ¨ BANNER PROMETHEUS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ns.tprint("\x1b[38;5;196m");
    ns.tprint("    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—");
    ns.tprint("    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•");
    ns.tprint("    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—");
    ns.tprint("    â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘");
    ns.tprint("    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘");
    ns.tprint("    â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•");
    ns.tprint("                              v45.0 - \"Stealing Fire From The Gods\"");
    ns.tprint("\x1b[0m");
    ns.tprint("");
    ns.tprint("ğŸ”¥ Initialisation du systÃ¨me PROMETHEUS...");
    ns.tprint("");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”§ INITIALISATION DES COMPOSANTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const log = new Logger(ns, "ORCHESTRATOR");
    
    try {
        // Capabilities
        log.info("ğŸ“‹ Initialisation des Capabilities...");
        const caps = new Capabilities(ns);
        caps.printReport(true);
        ns.tprint("");
        
        // Network
        log.info("ğŸŒ Initialisation du Network Scanner...");
        const network = new Network(ns, caps);
        const servers = network.refresh();
        ns.tprint(`âœ… ${servers.length} serveurs dÃ©tectÃ©s`);
        ns.tprint("");
        
        // Crack automatique
        log.info("ğŸ”“ Crack automatique des serveurs...");
        let cracked = 0;
        for (const server of servers) {
            if (!ns.hasRootAccess(server)) {
                if (network.crack(server)) {
                    cracked++;
                }
            }
        }
        ns.tprint(`âœ… ${cracked} serveurs crackÃ©s`);
        ns.tprint("");
        
        // PortHandler
        log.info("ğŸ“¨ Initialisation du PortHandler...");
        const portHandler = new PortHandler(ns);
        portHandler.clear(CONFIG.PORTS.COMMANDS); // Clear port au dÃ©marrage
        ns.tprint("âœ… PortHandler initialisÃ©");
        ns.tprint("");
        
        // RamManager
        log.info("ğŸ’¾ Initialisation du RamManager...");
        const ramMgr = new RamManager(ns);
        const pools = ramMgr.getRamPools();
        ns.tprint(`âœ… ${ns.formatRam(pools.totalFree)} RAM disponible`);
        ns.tprint("");
        
        // Batcher
        log.info("ğŸ”¥ Initialisation du Batcher PROMETHEUS...");
        const batcher = new Batcher(ns, network, ramMgr, portHandler, caps);
        ns.tprint("âœ… Batcher PROMETHEUS initialisÃ©");
        ns.tprint("");
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸš€ DÃ‰MARRAGE DU CONTROLLER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        log.info("ğŸ® DÃ©marrage du Controller...");
        
        // VÃ©rifier si le controller existe
        if (!ns.fileExists("/hack/controller.js", "home")) {
            log.error("Controller introuvable: /hack/controller.js");
            ns.tprint("âŒ ERREUR: Controller introuvable");
            return;
        }
        
        // Lancer le controller
        const controllerPID = ns.run("/hack/controller.js");
        
        if (controllerPID === 0) {
            log.error("Ã‰chec du dÃ©marrage du controller");
            ns.tprint("âŒ ERREUR: Impossible de dÃ©marrer le controller");
            return;
        }
        
        ns.tprint(`âœ… Controller dÃ©marrÃ© (PID: ${controllerPID})`);
        ns.tprint("");
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“Š MÃ‰TRIQUES INITIALES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const metrics = {
            startTime: Date.now(),
            cyclesCompleted: 0,
            batchesDispatched: 0,
            totalErrors: 0,
            lastRefreshTime: 0
        };
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”„ CONFIGURATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const REFRESH_INTERVAL = CONFIG.ORCHESTRATOR?.REFRESH_INTERVAL_MS || 60000; // 60s dÃ©faut
        const MAX_TARGETS = CONFIG.ORCHESTRATOR?.MAX_TARGETS || 3;
        
        log.success("âœ… SystÃ¨me PROMETHEUS opÃ©rationnel !");
        log.info(`â±ï¸  Refresh interval: ${REFRESH_INTERVAL / 1000}s`);
        log.info(`ğŸ¯ Max targets: ${MAX_TARGETS}`);
        ns.tprint("");
        ns.tprint("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        ns.tprint("ğŸ”¥ PROMETHEUS v45.0 - DÃ‰MARRAGE COMPLET");
        ns.tprint("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        ns.tprint("");
        
        await ns.sleep(2000); // Pause dramatique
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â™¾ï¸ BOUCLE PRINCIPALE (INFINIE)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        while (true) {
            try {
                metrics.cyclesCompleted++;
                const cycleStart = Date.now();
                
                if (log.debugEnabled) {
                    log.debug(`ğŸ”„ Cycle ${metrics.cyclesCompleted} dÃ©marrÃ©`);
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // ğŸŒ REFRESH RÃ‰SEAU (si nÃ©cessaire)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                const timeSinceRefresh = Date.now() - metrics.lastRefreshTime;
                
                if (timeSinceRefresh > REFRESH_INTERVAL) {
                    try {
                        log.info("ğŸŒ Refresh du rÃ©seau...");
                        network.refresh(true); // Force refresh
                        
                        // Crack nouveaux serveurs
                        const allServers = network.refresh();
                        let newCracked = 0;
                        
                        for (const server of allServers) {
                            if (!ns.hasRootAccess(server)) {
                                if (network.crack(server)) {
                                    newCracked++;
                                    log.success(`ğŸ”“ Root obtenu: ${server}`);
                                }
                            }
                        }
                        
                        if (newCracked > 0) {
                            log.success(`âœ… ${newCracked} nouveaux serveurs crackÃ©s`);
                        }
                        
                        metrics.lastRefreshTime = Date.now();
                        
                    } catch (error) {
                        log.error(`Erreur lors du refresh: ${error.message}`);
                        metrics.totalErrors++;
                    }
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // ğŸ¯ SÃ‰LECTION DES CIBLES
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                let targets = [];
                
                try {
                    targets = network.getTopTargets(MAX_TARGETS);
                    
                    if (targets.length === 0) {
                        log.warn("âš ï¸  Aucune cible disponible");
                        await ns.sleep(10000); // Attendre 10s
                        continue;
                    }
                    
                    if (log.debugEnabled) {
                        log.debug(`ğŸ¯ Cibles sÃ©lectionnÃ©es: ${targets.join(", ")}`);
                    }
                    
                } catch (error) {
                    log.error(`Erreur lors de la sÃ©lection des cibles: ${error.message}`);
                    metrics.totalErrors++;
                    await ns.sleep(10000);
                    continue;
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // ğŸ”¥ DISPATCH DES BATCHS
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                for (const target of targets) {
                    try {
                        if (log.debugEnabled) {
                            log.debug(`ğŸ”¥ Dispatching batch vers ${target}...`);
                        }
                        
                        const result = await batcher.executeBatch(target);
                        
                        if (result.success) {
                            metrics.batchesDispatched++;
                            
                            if (log.debugEnabled) {
                                log.debug(`âœ… Batch ${target}: ${result.threadsUsed} threads`);
                            }
                        } else {
                            log.warn(`âš ï¸  Batch ${target} Ã©chouÃ©`);
                        }
                        
                    } catch (error) {
                        log.error(`Erreur batch ${target}: ${error.message}`);
                        metrics.totalErrors++;
                    }
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // ğŸ“Š MÃ‰TRIQUES PÃ‰RIODIQUES (toutes les 10 cycles)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                if (metrics.cyclesCompleted % 10 === 0) {
                    const uptime = Date.now() - metrics.startTime;
                    const uptimeMin = Math.floor(uptime / 60000);
                    
                    log.info(`ğŸ“Š Cycles: ${metrics.cyclesCompleted}, Batchs: ${metrics.batchesDispatched}, Uptime: ${uptimeMin}min`);
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // â±ï¸ SLEEP ENTRE CYCLES
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                const cycleDuration = Date.now() - cycleStart;
                const sleepTime = Math.max(1000, 5000 - cycleDuration); // Min 1s, cible 5s par cycle
                
                await ns.sleep(sleepTime);
                
            } catch (error) {
                // Erreur critique dans la boucle principale
                log.error(`ERREUR CRITIQUE dans la boucle: ${error.message}`);
                metrics.totalErrors++;
                
                // Attendre avant de retry
                await ns.sleep(10000);
            }
        }
        
    } catch (error) {
        // Erreur lors de l'initialisation
        log.error(`ERREUR FATALE lors de l'initialisation: ${error.message}`);
        ns.tprint(`âŒ ERREUR FATALE: ${error.message}`);
        ns.tprint("Le systÃ¨me PROMETHEUS n'a pas pu dÃ©marrer.");
    }
}

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ“š DOCUMENTATION TECHNIQUE
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * RÃ”LE DE L'ORCHESTRATOR :
 * -------------------------
 * L'orchestrator est le point d'entrÃ©e principal du systÃ¨me PROMETHEUS.
 * Il coordonne tous les composants et gÃ¨re le cycle de vie complet.
 * 
 * COMPOSANTS GÃ‰RÃ‰S :
 * ------------------
 * 1. Capabilities - DÃ©tection des APIs disponibles
 * 2. Network - Scanner et cracker du rÃ©seau
 * 3. PortHandler - Communication inter-scripts
 * 4. RamManager - Gestion de la RAM
 * 5. Batcher - Calcul et dispatch des batchs HWGW
 * 6. Controller - ExÃ©cution des workers (lancÃ© par orchestrator)
 * 
 * WORKFLOW :
 * ----------
 * Initialisation :
 *   â†’ Charge tous les modules
 *   â†’ Scan le rÃ©seau
 *   â†’ Crack les serveurs
 *   â†’ Lance le controller
 *   â†’ Entre dans la boucle principale
 * 
 * Boucle principale :
 *   â†’ Refresh rÃ©seau (toutes les 60s par dÃ©faut)
 *   â†’ Crack nouveaux serveurs
 *   â†’ SÃ©lectionne top N cibles (3 par dÃ©faut)
 *   â†’ Dispatch batch sur chaque cible via Batcher
 *   â†’ Sleep entre cycles (5s cible)
 *   â†’ RÃ©pÃ¨te
 * 
 * OPTIMISATIONS PROMETHEUS :
 * --------------------------
 * 
 * 1. REFRESH CONFIGURABLE
 *    Avant : Refresh hardcodÃ©
 *    Maintenant : CONFIG.ORCHESTRATOR.REFRESH_INTERVAL_MS
 *    Impact : Personnalisable selon les besoins
 * 
 * 2. TRY/CATCH ROBUSTE
 *    Avant : Crash sur erreur
 *    Maintenant : Continue toujours, log les erreurs
 *    Impact : SystÃ¨me stable mÃªme en cas d'erreurs
 * 
 * 3. MULTI-CIBLES
 *    Avant : Une seule cible
 *    Maintenant : Top N cibles (configurable)
 *    Impact : Meilleure utilisation de la RAM
 * 
 * 4. CRACK AUTOMATIQUE
 *    DÃ©tecte et crack automatiquement les nouveaux serveurs
 *    Impact : Toujours Ã  jour
 * 
 * CONFIGURATION :
 * ---------------
 * Dans constants.js, ajouter :
 * 
 * CONFIG.ORCHESTRATOR = {
 *   REFRESH_INTERVAL_MS: 60000,  // Refresh rÃ©seau (60s)
 *   MAX_TARGETS: 3                // Nombre de cibles simultanÃ©es
 * };
 * 
 * MÃ‰TRIQUES :
 * -----------
 * L'orchestrator track :
 * - cyclesCompleted : Nombre de cycles de la boucle principale
 * - batchesDispatched : Nombre total de batchs dispatchÃ©s
 * - totalErrors : Nombre d'erreurs rencontrÃ©es
 * - uptime : Temps Ã©coulÃ© depuis le dÃ©marrage
 * 
 * DÃ‰MARRAGE :
 * -----------
 * Pour dÃ©marrer le systÃ¨me complet :
 * 
 * ns.run("/core/orchestrator.js");
 * 
 * L'orchestrator :
 * 1. Affiche le banner PROMETHEUS
 * 2. Initialise tous les composants
 * 3. Lance le controller
 * 4. Entre dans la boucle principale
 * 
 * MONITORING :
 * ------------
 * Pour monitorer l'orchestrator :
 * 
 * ns.tail("/core/orchestrator.js");
 * 
 * Les logs affichent :
 * - Initialisation des composants
 * - Refresh rÃ©seau pÃ©riodiques
 * - Nouveaux serveurs crackÃ©s
 * - Batchs dispatchÃ©s
 * - MÃ©triques (tous les 10 cycles)
 * - Erreurs
 * 
 * ARRÃŠT :
 * -------
 * Pour arrÃªter proprement le systÃ¨me :
 * 
 * ns.kill("/core/orchestrator.js", "home");
 * ns.kill("/hack/controller.js", "home");
 * 
 * L'orchestrator s'arrÃªtera et le controller aussi.
 * Les workers en cours continueront jusqu'Ã  leur fin.
 * 
 * DEBUGGING :
 * -----------
 * Pour activer les logs dÃ©taillÃ©s :
 * 
 * // Dans constants.js
 * CONFIG.SYSTEM.DEBUG_MODE = true;
 * 
 * Cela affichera :
 * - Chaque cycle
 * - Chaque cible sÃ©lectionnÃ©e
 * - Chaque batch dispatchÃ©
 * - Threads utilisÃ©s par batch
 * 
 * GESTION DES ERREURS :
 * ---------------------
 * L'orchestrator est conÃ§u pour ne jamais crasher.
 * Toutes les erreurs sont catchÃ©es et loggÃ©es.
 * Le systÃ¨me continue toujours de fonctionner.
 * 
 * Types d'erreurs gÃ©rÃ©es :
 * - Erreur d'initialisation â†’ Stop
 * - Erreur de refresh â†’ Log + continue
 * - Erreur de sÃ©lection cibles â†’ Log + continue
 * - Erreur de batch â†’ Log + continue
 * - Erreur dans boucle principale â†’ Log + retry
 * 
 * INTÃ‰GRATION :
 * -------------
 * L'orchestrator s'intÃ¨gre avec :
 * - Dashboard : Affiche les mÃ©triques
 * - Watcher : Monitore les cibles
 * - Tous les composants via imports
 * 
 * TIPS :
 * ------
 * 1. Lancer l'orchestrator en premier (boot du systÃ¨me)
 * 2. Ajuster REFRESH_INTERVAL selon besoins (60s par dÃ©faut)
 * 3. Ajuster MAX_TARGETS selon RAM disponible (3 par dÃ©faut)
 * 4. Monitorer les logs pour dÃ©tecter problÃ¨mes
 * 5. Le controller DOIT Ãªtre prÃ©sent avant de lancer l'orchestrator
 * 
 * PERFORMANCE :
 * -------------
 * RAM : ~5 GB (orchestrator + tous les modules)
 * CPU : Faible (sleep entre cycles)
 * Cycle duration : ~5s (ajustÃ© dynamiquement)
 * 
 * L'orchestrator peut gÃ©rer des centaines de serveurs et des dizaines
 * de batchs par minute sans problÃ¨me de performance.
 */
