/**
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
 * â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
 * â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•
 *                           v45.0 - "Stealing Fire From The Gods"
 * 
 * @module      managers/corp-manager
 * @description Gestionnaire automatique de Corporation (SF3).
 *              GÃ¨re divisions, produits, upgrades, financement et expansion.
 * @author      Claude (Anthropic) + tylersense-ui
 * @version     45.0 - PROMETHEUS
 * @date        2025-01-XX
 * @license     MIT
 * @requires    BitBurner v2.8.1+ (Steam), Corporation API (SF3)
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”¥ PROMETHEUS ENHANCEMENTS
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * âœ“ VÃ©rification caps.corp avant toute opÃ©ration
 * âœ“ Progression par Ã©tapes (bootstrap â†’ growth â†’ optimization)
 * âœ“ Gestion intelligente des rounds de financement
 * âœ“ CrÃ©ation et expansion de divisions stratÃ©giques
 * âœ“ DÃ©veloppement automatique de produits
 * âœ“ Upgrades priorisÃ©es par ROI
 * âœ“ Hiring automatique selon budget et demande
 * âœ“ Gestion des materials et supply chains
 * âœ“ Research & Development automation
 * âœ“ Try/catch robuste sur TOUTES les opÃ©rations corp
 * âœ“ MÃ©triques dÃ©taillÃ©es (revenue, profit, valuation)
 * âœ“ Logs professionnels avec contexte stratÃ©gique
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * @usage
 *   ns.run("/managers/corp-manager.js");
 *   // GÃ¨re automatiquement la corporation (de zÃ©ro Ã  l'IPO)
 * 
 * @example
 *   // Mode agressif (expansion rapide)
 *   // Dans constants.js : CONFIG.CORP.STRATEGY = "aggressive"
 *   ns.run("/managers/corp-manager.js");
 * 
 * @strategy
 *   Phase 1 - Bootstrap: CrÃ©ation corp + Agriculture Division (Sector-12)
 *   Phase 2 - Growth: Expansion gÃ©ographique + Tobacco Division
 *   Phase 3 - Optimization: Upgrades, R&D, Products, IPO
 */

import { CONFIG } from "/lib/constants.js";
import { Logger } from "/lib/logger.js";
import { Capabilities } from "/lib/capabilities.js";

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * âš™ï¸  CONFIGURATION CORPORATION
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
const CORP_CONFIG = {
    /** StratÃ©gie (conservative, balanced, aggressive) */
    STRATEGY: CONFIG.CORP?.STRATEGY || "balanced",
    
    /** Check interval (10s) */
    CHECK_INTERVAL: 10000,
    
    /** Nom de la corporation */
    CORP_NAME: CONFIG.CORP?.NAME || "Prometheus Industries",
    
    /** Divisions Ã  crÃ©er (par ordre de prioritÃ©) */
    TARGET_DIVISIONS: [
        { name: "Agriculture", type: "Agriculture", priority: 1 },
        { name: "Tobacco", type: "Tobacco", priority: 2 },
        { name: "Software", type: "Software", priority: 3 }
    ],
    
    /** Villes d'expansion (par ordre) */
    TARGET_CITIES: [
        "Sector-12",
        "Aevum",
        "Chongqing",
        "New Tokyo",
        "Ishima",
        "Volhaven"
    ],
    
    /** Upgrades prioritaires */
    PRIORITY_UPGRADES: [
        "Smart Factories",
        "Smart Storage",
        "DreamSense",
        "Wilson Analytics",
        "Nuoptimal Nootropic Injector Implants",
        "Speech Processor Implants",
        "Neural Accelerators",
        "FocusWires"
    ]
};

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ¢ PHASES DE DÃ‰VELOPPEMENT
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
const PHASE = {
    BOOTSTRAP: "bootstrap",   // CrÃ©ation corp + 1Ã¨re division
    GROWTH: "growth",         // Expansion + financing rounds
    OPTIMIZATION: "optimization", // Upgrades + products + IPO
    COMPLETE: "complete"      // IPO rÃ©alisÃ©e
};

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”§ MAIN FUNCTION
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Boucle principale de gestion de la corporation.
 * 
 * @param {NS} ns - Namespace BitBurner
 */
export async function main(ns) {
    ns.disableLog("ALL");
    
    const log = new Logger(ns, "CORP-MGR");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ” VÃ‰RIFICATION DES CAPACITÃ‰S
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const caps = new Capabilities(ns);
    
    if (!caps.corp) {
        log.error("Corporation API requise (SF3)");
        ns.tprint("âŒ Ce manager nÃ©cessite l'API Corporation (Source-File 3)");
        ns.tprint("   Terminez BitNode 3 pour dÃ©bloquer cette fonctionnalitÃ©");
        return;
    }
    
    log.success("âœ… Corporation API dÃ©tectÃ©e - DÃ©marrage du manager");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“Š MÃ‰TRIQUES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const metrics = {
        currentPhase: PHASE.BOOTSTRAP,
        divisionsCreated: 0,
        upgradesPurchased: 0,
        productsLaunched: 0,
        investmentRounds: 0,
        totalRevenue: 0,
        cyclesCompleted: 0,
        startTime: Date.now()
    };
    
    log.info(`âš™ï¸  Configuration:`);
    log.info(`   StratÃ©gie: ${CORP_CONFIG.STRATEGY}`);
    log.info(`   Corp name: ${CORP_CONFIG.CORP_NAME}`);
    log.info(`   Check interval: ${CORP_CONFIG.CHECK_INTERVAL / 1000}s`);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â™¾ï¸ BOUCLE PRINCIPALE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    while (true) {
        try {
            metrics.cyclesCompleted++;
            const player = ns.getPlayer();
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ¢ VÃ‰RIFICATION EXISTENCE CORPORATION
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            let corpExists = false;
            try {
                const corp = ns.corporation.getCorporation();
                corpExists = true;
            } catch (error) {
                // Corporation n'existe pas encore
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ†• PHASE BOOTSTRAP: CRÃ‰ATION CORPORATION
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (!corpExists && metrics.currentPhase === PHASE.BOOTSTRAP) {
                try {
                    // VÃ©rifier si on peut crÃ©er une corp (SF3 ou $150B)
                    const canCreate = player.money >= 150_000_000_000;
                    
                    if (canCreate) {
                        const created = ns.corporation.createCorporation(CORP_CONFIG.CORP_NAME, false);
                        
                        if (created) {
                            log.success(`ğŸ¢ Corporation crÃ©Ã©e: ${CORP_CONFIG.CORP_NAME}`);
                            corpExists = true;
                        }
                    } else if (metrics.cyclesCompleted % 20 === 0) {
                        log.info(`ğŸ’° Fonds insuffisants pour crÃ©er corp (besoin: $150B)`);
                    }
                } catch (error) {
                    log.error(`Erreur crÃ©ation corporation: ${error.message}`);
                }
                
                if (!corpExists) {
                    await ns.sleep(CORP_CONFIG.CHECK_INTERVAL);
                    continue;
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ“Š RÃ‰CUPÃ‰RATION DES INFOS CORPORATION
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            let corp = null;
            try {
                corp = ns.corporation.getCorporation();
            } catch (error) {
                log.error(`Erreur lecture corporation: ${error.message}`);
                await ns.sleep(CORP_CONFIG.CHECK_INTERVAL);
                continue;
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ­ GESTION DES DIVISIONS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            for (const targetDiv of CORP_CONFIG.TARGET_DIVISIONS) {
                if (corp.divisions.includes(targetDiv.name)) {
                    continue; // Division dÃ©jÃ  crÃ©Ã©e
                }
                
                try {
                    // VÃ©rifier si on peut se permettre la division
                    const divCost = 1_000_000_000; // $1B approximatif
                    
                    if (corp.funds >= divCost * 2) { // Garder une marge
                        ns.corporation.expandIndustry(targetDiv.type, targetDiv.name);
                        metrics.divisionsCreated++;
                        
                        log.success(`ğŸ­ Division crÃ©Ã©e: ${targetDiv.name} (${targetDiv.type})`);
                        
                        // Expansion dans la premiÃ¨re ville
                        try {
                            ns.corporation.expandCity(targetDiv.name, CORP_CONFIG.TARGET_CITIES[0]);
                            log.info(`   Expandue Ã  ${CORP_CONFIG.TARGET_CITIES[0]}`);
                        } catch (error) {
                            log.error(`Erreur expansion city: ${error.message}`);
                        }
                    }
                } catch (error) {
                    log.error(`Erreur crÃ©ation division ${targetDiv.name}: ${error.message}`);
                }
                
                break; // Une division par cycle max
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ’° ROUNDS DE FINANCEMENT
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            try {
                const investOffer = ns.corporation.getInvestmentOffer();
                
                if (investOffer.round < 4 && investOffer.funds > 0) {
                    // Accepter si on a besoin de liquiditÃ©s
                    if (corp.funds < 10_000_000_000) { // < $10B
                        const accepted = ns.corporation.acceptInvestmentOffer();
                        
                        if (accepted) {
                            metrics.investmentRounds++;
                            log.success(`ğŸ’° Round ${investOffer.round} acceptÃ©: ${ns.formatNumber(investOffer.funds)}`);
                            log.info(`   Dilution: ${(corp.sharePrice * corp.totalShares).toFixed(2)}%`);
                        }
                    }
                }
            } catch (error) {
                // getInvestmentOffer peut Ã©chouer
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // â¬†ï¸  UPGRADES DE CORPORATION
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (corp.funds > 1_000_000_000 && metrics.cyclesCompleted % 10 === 0) {
                for (const upgradeName of CORP_CONFIG.PRIORITY_UPGRADES) {
                    try {
                        const currentLevel = ns.corporation.getUpgradeLevel(upgradeName);
                        const upgradeCost = ns.corporation.getUpgradeLevelCost(upgradeName);
                        
                        // Acheter si on peut se le permettre (max 10% des fonds)
                        if (upgradeCost > 0 && upgradeCost < corp.funds * 0.1) {
                            ns.corporation.levelUpgrade(upgradeName);
                            metrics.upgradesPurchased++;
                            
                            if (log.debugEnabled) {
                                log.debug(`â¬†ï¸  Upgrade: ${upgradeName} â†’ ${currentLevel + 1}`);
                            }
                            
                            break; // Un upgrade par cycle
                        }
                    } catch (error) {
                        // Upgrade peut ne pas exister
                    }
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ™ï¸  EXPANSION GÃ‰OGRAPHIQUE DES DIVISIONS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (corp.funds > 5_000_000_000 && metrics.cyclesCompleted % 15 === 0) {
                for (const divName of corp.divisions) {
                    try {
                        const division = ns.corporation.getDivision(divName);
                        
                        // Trouver la prochaine ville Ã  expand
                        for (const city of CORP_CONFIG.TARGET_CITIES) {
                            if (!division.cities.includes(city)) {
                                try {
                                    ns.corporation.expandCity(divName, city);
                                    log.success(`ğŸ™ï¸  ${divName} expandue Ã  ${city}`);
                                    break;
                                } catch (error) {
                                    // Peut Ã©chouer si pas assez de fonds
                                }
                            }
                        }
                    } catch (error) {
                        // getDivision peut Ã©chouer
                    }
                    
                    break; // Une expansion par cycle
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ‘” HIRING AUTOMATIQUE
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (corp.funds > 10_000_000_000 && metrics.cyclesCompleted % 20 === 0) {
                for (const divName of corp.divisions) {
                    try {
                        const division = ns.corporation.getDivision(divName);
                        
                        for (const city of division.cities) {
                            try {
                                const office = ns.corporation.getOffice(divName, city);
                                
                                // Embaucher si moins de 30 employÃ©s
                                if (office.employees.length < 30) {
                                    const toHire = Math.min(3, 30 - office.employees.length);
                                    
                                    try {
                                        ns.corporation.hireEmployee(divName, city, toHire);
                                        
                                        if (log.debugEnabled) {
                                            log.debug(`ğŸ‘” ${divName}/${city}: +${toHire} employÃ©s`);
                                        }
                                    } catch (error) {
                                        // Hiring peut Ã©chouer
                                    }
                                }
                                
                                // Assigner les rÃ´les automatiquement (Ã©quilibrÃ©)
                                try {
                                    const totalEmployees = office.employees.length;
                                    const perRole = Math.floor(totalEmployees / 5);
                                    
                                    ns.corporation.setAutoJobAssignment(divName, city, "Operations", perRole);
                                    ns.corporation.setAutoJobAssignment(divName, city, "Engineer", perRole);
                                    ns.corporation.setAutoJobAssignment(divName, city, "Business", perRole);
                                    ns.corporation.setAutoJobAssignment(divName, city, "Management", perRole);
                                    ns.corporation.setAutoJobAssignment(divName, city, "Research & Development", totalEmployees - (perRole * 4));
                                } catch (error) {
                                    // setAutoJobAssignment peut Ã©chouer
                                }
                            } catch (error) {
                                // getOffice peut Ã©chouer
                            }
                        }
                    } catch (error) {
                        // getDivision peut Ã©chouer
                    }
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ’ DÃ‰VELOPPEMENT DE PRODUITS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (corp.funds > 50_000_000_000 && metrics.cyclesCompleted % 100 === 0) {
                for (const divName of corp.divisions) {
                    try {
                        const division = ns.corporation.getDivision(divName);
                        
                        // Seulement pour Software et Tobacco (ont des produits)
                        if (division.type === "Software" || division.type === "Tobacco") {
                            const productName = `Product-${metrics.productsLaunched + 1}`;
                            const investAmount = 1_000_000_000; // $1B
                            
                            try {
                                ns.corporation.makeProduct(
                                    divName,
                                    division.cities[0],
                                    productName,
                                    investAmount,
                                    investAmount
                                );
                                
                                metrics.productsLaunched++;
                                log.success(`ğŸ’ Produit lancÃ©: ${productName} (${divName})`);
                                log.info(`   Investissement: ${ns.formatNumber(investAmount * 2)}`);
                            } catch (error) {
                                // makeProduct peut Ã©chouer
                            }
                        }
                    } catch (error) {
                        // getDivision peut Ã©chouer
                    }
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ“Š CALCUL DES REVENUS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            metrics.totalRevenue = corp.revenue;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ“Š RAPPORT PÃ‰RIODIQUE (toutes les 10 cycles)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (metrics.cyclesCompleted % 10 === 0) {
                const uptime = Date.now() - metrics.startTime;
                const uptimeMin = Math.floor(uptime / 60000);
                
                log.info(`ğŸ“Š Stats Corporation:`);
                log.info(`   Nom: ${corp.name}`);
                log.info(`   Divisions: ${corp.divisions.length}/${CORP_CONFIG.TARGET_DIVISIONS.length}`);
                log.info(`   Fonds: ${ns.formatNumber(corp.funds)}`);
                log.info(`   Revenue: ${ns.formatNumber(corp.revenue)}/s`);
                log.info(`   Profit: ${ns.formatNumber(corp.revenue - corp.expenses)}/s`);
                log.info(`   Upgrades: ${metrics.upgradesPurchased} | Produits: ${metrics.productsLaunched}`);
                log.info(`   Rounds: ${metrics.investmentRounds} | Uptime: ${uptimeMin}min`);
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ¯ MISE Ã€ JOUR DE LA PHASE
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (metrics.currentPhase === PHASE.BOOTSTRAP && corp.divisions.length >= 1) {
                metrics.currentPhase = PHASE.GROWTH;
                log.success(`ğŸš€ Phase GROWTH activÃ©e`);
            }
            
            if (metrics.currentPhase === PHASE.GROWTH && corp.divisions.length >= 2) {
                metrics.currentPhase = PHASE.OPTIMIZATION;
                log.success(`ğŸš€ Phase OPTIMIZATION activÃ©e`);
            }
            
        } catch (error) {
            log.error(`Erreur dans la boucle principale: ${error.message}`);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â±ï¸  SLEEP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        await ns.sleep(CORP_CONFIG.CHECK_INTERVAL);
    }
}
