/**
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
 * â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
 * â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•
 *                           v45.0 - "Stealing Fire From The Gods"
 * 
 * @module      managers/singularity-manager
 * @description Gestionnaire automatique des activitÃ©s Singularity (SF4).
 *              GÃ¨re factions, augmentations, crimes, Ã©tudes et backdoors.
 * @author      Claude (Anthropic) + tylersense-ui
 * @version     45.0 - PROMETHEUS
 * @date        2025-01-XX
 * @license     MIT
 * @requires    BitBurner v2.8.1+ (Steam), Singularity API (SF4)
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”¥ PROMETHEUS ENHANCEMENTS
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * âœ“ VÃ©rification caps.singularity avant toute opÃ©ration
 * âœ“ Gestion intelligente des factions (prioritÃ© selon objectifs)
 * âœ“ Achat automatique des augmentations par ordre de prioritÃ©
 * âœ“ Crimes optimisÃ©s selon stats et objectifs (argent vs karma)
 * âœ“ Gestion des Ã©tudes universitaires (informatique, leadership)
 * âœ“ Backdoor automatique des serveurs critiques (factions)
 * âœ“ Try/catch robuste sur tous les appels Singularity
 * âœ“ MÃ©triques dÃ©taillÃ©es (augs achetÃ©es, rep gagnÃ©e, crimes rÃ©ussis)
 * âœ“ Logs professionnels avec contexte et progression
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * @usage
 *   ns.run("/managers/singularity-manager.js");
 *   // GÃ¨re automatiquement progression factions et augmentations
 * 
 * @example
 *   // Mode focus augmentations de hack
 *   // Dans constants.js : CONFIG.SINGULARITY.FOCUS = "hacking"
 *   ns.run("/managers/singularity-manager.js");
 */

import { CONFIG } from "/lib/constants.js";
import { Logger } from "/lib/logger.js";
import { Capabilities } from "/lib/capabilities.js";

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * âš™ï¸  CONFIGURATION SINGULARITY
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
const SINGULARITY_CONFIG = {
    /** Focus principal (hacking, combat, charisma, money) */
    FOCUS: CONFIG.SINGULARITY?.FOCUS || "hacking",
    
    /** Argent minimum Ã  garder en rÃ©serve */
    MIN_BUDGET: CONFIG.SINGULARITY?.MIN_BUDGET || 1_000_000_000,
    
    /** Rep minimum avant d'acheter des augs */
    MIN_REP_FOR_PURCHASE: CONFIG.SINGULARITY?.MIN_REP || 100_000,
    
    /** Check interval (30s) */
    CHECK_INTERVAL: 30000,
    
    /** Enable backdoor automatique */
    AUTO_BACKDOOR: CONFIG.SINGULARITY?.AUTO_BACKDOOR ?? true,
    
    /** Enable crime farming */
    AUTO_CRIME: CONFIG.SINGULARITY?.AUTO_CRIME ?? true,
    
    /** Enable faction work */
    AUTO_FACTION_WORK: CONFIG.SINGULARITY?.AUTO_FACTION_WORK ?? true
};

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ¯ FACTIONS PRIORITAIRES
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Liste des factions importantes avec leurs conditions d'accÃ¨s.
 */
const PRIORITY_FACTIONS = [
    // Tier S - Endgame factions
    { name: "Daedalus", priority: 1, reqHack: 2500, reqAugs: 30, backdoor: "The-Cave" },
    { name: "The Covenant", priority: 1, reqHack: 850, reqAugs: 20, backdoor: null },
    { name: "Illuminati", priority: 1, reqHack: 1500, reqAugs: 30, backdoor: null },
    
    // Tier A - Strong factions
    { name: "BitRunners", priority: 2, reqHack: 500, backdoor: "run4theh111z" },
    { name: "NiteSec", priority: 2, reqHack: 200, backdoor: "avmnite-02h" },
    { name: "The Black Hand", priority: 2, reqHack: 350, backdoor: "I.I.I.I" },
    
    // Tier B - Early game factions
    { name: "CyberSec", priority: 3, reqHack: 50, backdoor: "CSEC" },
    { name: "Netburners", priority: 3, reqHack: 80, backdoor: null },
    { name: "Tian Di Hui", priority: 3, reqHack: 50, backdoor: null }
];

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ’ AUGMENTATIONS PRIORITAIRES
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
const PRIORITY_AUGMENTATIONS = {
    hacking: [
        "The Red Pill", // +BitNode multipliers
        "CashRoot Starter Kit",
        "Neuroreceptor Management Implant",
        "BitWire",
        "Artificial Bio-neural Network Implant",
        "Cranial Signal Processors - Gen V"
    ],
    combat: [
        "Graphene Bone Lacings",
        "Bionic Arms",
        "Nanofiber Weave",
        "Synthetic Heart"
    ],
    charisma: [
        "Social Negotiation Assistant (S.N.A)",
        "ADR-V2 Pheromone Gene"
    ]
};

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”§ MAIN FUNCTION
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Boucle principale de gestion Singularity.
 * 
 * @param {NS} ns - Namespace BitBurner
 */
export async function main(ns) {
    ns.disableLog("ALL");
    
    const log = new Logger(ns, "SINGULARITY");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ” VÃ‰RIFICATION DES CAPACITÃ‰S
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const caps = new Capabilities(ns);
    
    if (!caps.singularity) {
        log.error("Singularity API requise (SF4)");
        ns.tprint("âŒ Ce manager nÃ©cessite l'API Singularity (Source-File 4)");
        ns.tprint("   Terminez BitNode 4 pour dÃ©bloquer cette fonctionnalitÃ©");
        return;
    }
    
    log.success("âœ… Singularity API dÃ©tectÃ©e - DÃ©marrage du manager");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“Š MÃ‰TRIQUES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const metrics = {
        augmentationsPurchased: 0,
        factionsJoined: 0,
        backdoorsInstalled: 0,
        crimesCommitted: 0,
        totalRepEarned: 0,
        cyclesCompleted: 0,
        startTime: Date.now()
    };
    
    log.info(`âš™ï¸  Configuration:`);
    log.info(`   Focus: ${SINGULARITY_CONFIG.FOCUS}`);
    log.info(`   Budget min: ${ns.formatNumber(SINGULARITY_CONFIG.MIN_BUDGET)}`);
    log.info(`   Auto-backdoor: ${SINGULARITY_CONFIG.AUTO_BACKDOOR ? 'âœ…' : 'âŒ'}`);
    log.info(`   Auto-crime: ${SINGULARITY_CONFIG.AUTO_CRIME ? 'âœ…' : 'âŒ'}`);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â™¾ï¸ BOUCLE PRINCIPALE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    while (true) {
        try {
            metrics.cyclesCompleted++;
            const player = ns.getPlayer();
            const budget = player.money;
            const availableBudget = budget - SINGULARITY_CONFIG.MIN_BUDGET;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ¯ GESTION DES FACTIONS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            try {
                const playerFactions = ns.singularity.checkFactionInvitations();
                
                for (const factionName of playerFactions) {
                    // VÃ©rifier si c'est une faction prioritaire
                    const priorityFaction = PRIORITY_FACTIONS.find(f => f.name === factionName);
                    
                    if (priorityFaction) {
                        try {
                            const joined = ns.singularity.joinFaction(factionName);
                            
                            if (joined) {
                                metrics.factionsJoined++;
                                log.success(`âœ… Faction rejointe: ${factionName}`);
                                log.info(`   PrioritÃ©: ${priorityFaction.priority}`);
                            }
                        } catch (error) {
                            log.error(`Erreur en rejoignant ${factionName}: ${error.message}`);
                        }
                    }
                }
            } catch (error) {
                log.error(`Erreur lors de la gestion des factions: ${error.message}`);
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ”“ BACKDOORS AUTOMATIQUES
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (SINGULARITY_CONFIG.AUTO_BACKDOOR && metrics.cyclesCompleted % 5 === 0) {
                try {
                    for (const faction of PRIORITY_FACTIONS) {
                        if (!faction.backdoor) continue;
                        
                        // VÃ©rifier si le serveur existe et est accessible
                        if (!ns.serverExists(faction.backdoor)) continue;
                        
                        const server = ns.getServer(faction.backdoor);
                        
                        // VÃ©rifier si backdoor dÃ©jÃ  installÃ©
                        if (server.backdoorInstalled) continue;
                        
                        // VÃ©rifier si on a root access
                        if (!server.hasAdminRights) continue;
                        
                        // VÃ©rifier le niveau de hack requis
                        if (player.skills.hacking < server.requiredHackingSkill) continue;
                        
                        // Installer le backdoor
                        try {
                            await ns.singularity.installBackdoor();
                            metrics.backdoorsInstalled++;
                            log.success(`ğŸ”“ Backdoor installÃ©: ${faction.backdoor}`);
                            log.info(`   Faction dÃ©bloquÃ©e: ${faction.name}`);
                        } catch (error) {
                            // Peut Ã©chouer si pas connectÃ© au serveur
                            if (log.debugEnabled) {
                                log.debug(`Backdoor ${faction.backdoor}: ${error.message}`);
                            }
                        }
                    }
                } catch (error) {
                    log.error(`Erreur lors de l'installation de backdoors: ${error.message}`);
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ’ ACHAT D'AUGMENTATIONS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (availableBudget > 0) {
                try {
                    const joinedFactions = ns.getPlayer().factions;
                    const priorityAugs = PRIORITY_AUGMENTATIONS[SINGULARITY_CONFIG.FOCUS] || [];
                    
                    for (const factionName of joinedFactions) {
                        try {
                            const factionAugs = ns.singularity.getAugmentationsFromFaction(factionName);
                            const factionRep = ns.singularity.getFactionRep(factionName);
                            
                            for (const augName of priorityAugs) {
                                // VÃ©rifier si l'aug est disponible dans cette faction
                                if (!factionAugs.includes(augName)) continue;
                                
                                // VÃ©rifier si dÃ©jÃ  possÃ©dÃ©e
                                const ownedAugs = ns.singularity.getOwnedAugmentations(true);
                                if (ownedAugs.includes(augName)) continue;
                                
                                // VÃ©rifier la rep requise
                                const augStats = ns.singularity.getAugmentationRepReq(augName);
                                if (factionRep < augStats) continue;
                                
                                // VÃ©rifier le prix
                                const augPrice = ns.singularity.getAugmentationPrice(augName);
                                if (augPrice > availableBudget) continue;
                                
                                // Acheter l'augmentation
                                try {
                                    const purchased = ns.singularity.purchaseAugmentation(factionName, augName);
                                    
                                    if (purchased) {
                                        metrics.augmentationsPurchased++;
                                        log.success(`ğŸ’ Augmentation achetÃ©e: ${augName}`);
                                        log.info(`   Faction: ${factionName}`);
                                        log.info(`   Prix: ${ns.formatNumber(augPrice)}`);
                                    }
                                } catch (error) {
                                    log.error(`Erreur achat ${augName}: ${error.message}`);
                                }
                            }
                        } catch (error) {
                            if (log.debugEnabled) {
                                log.debug(`Erreur faction ${factionName}: ${error.message}`);
                            }
                        }
                    }
                } catch (error) {
                    log.error(`Erreur lors de l'achat d'augmentations: ${error.message}`);
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ’° FARM DE CRIMES (si configurÃ©)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (SINGULARITY_CONFIG.AUTO_CRIME) {
                try {
                    const currentWork = ns.singularity.getCurrentWork();
                    
                    // Si pas occupÃ©, commencer un crime
                    if (!currentWork || currentWork.type !== "CRIME") {
                        // SÃ©lectionner le meilleur crime selon le focus
                        let bestCrime = "Shoplift"; // Crime par dÃ©faut
                        
                        if (SINGULARITY_CONFIG.FOCUS === "money") {
                            bestCrime = "Heist"; // Max money
                        } else if (SINGULARITY_CONFIG.FOCUS === "combat") {
                            bestCrime = "Mug"; // Max combat XP
                        } else if (SINGULARITY_CONFIG.FOCUS === "hacking") {
                            bestCrime = "Shoplift"; // Rapide et safe
                        }
                        
                        try {
                            ns.singularity.commitCrime(bestCrime, false);
                            metrics.crimesCommitted++;
                            
                            if (log.debugEnabled && metrics.cyclesCompleted % 20 === 0) {
                                log.debug(`ğŸ”« Crime en cours: ${bestCrime}`);
                            }
                        } catch (error) {
                            // Crime peut Ã©chouer si dÃ©jÃ  occupÃ©
                        }
                    }
                } catch (error) {
                    // getCurrentWork peut ne pas Ãªtre disponible
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ“Š RAPPORT PÃ‰RIODIQUE (toutes les 20 cycles)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (metrics.cyclesCompleted % 20 === 0) {
                const uptime = Date.now() - metrics.startTime;
                const uptimeMin = Math.floor(uptime / 60000);
                
                log.info(`ğŸ“Š Stats Singularity:`);
                log.info(`   Factions: ${player.factions.length} rejointes`);
                log.info(`   Augs achetÃ©es: ${metrics.augmentationsPurchased}`);
                log.info(`   Backdoors: ${metrics.backdoorsInstalled}`);
                log.info(`   Crimes: ${metrics.crimesCommitted}`);
                log.info(`   Uptime: ${uptimeMin}min`);
            }
            
        } catch (error) {
            log.error(`Erreur dans la boucle principale: ${error.message}`);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â±ï¸  SLEEP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        await ns.sleep(SINGULARITY_CONFIG.CHECK_INTERVAL);
    }
}
