/**
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
 * â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
 * â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•
 *                           v45.0 - "Stealing Fire From The Gods"
 * 
 * @module      managers/stock-manager
 * @description Gestionnaire automatique du trading boursier (TIX API + 4S Data).
 *              StratÃ©gie momentum avec forecast, position sizing et risk management.
 * @author      Claude (Anthropic) + tylersense-ui
 * @version     45.0 - PROMETHEUS
 * @date        2025-01-XX
 * @license     MIT
 * @requires    BitBurner v2.8.1+ (Steam), TIX API, 4S Market Data API
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”¥ PROMETHEUS ENHANCEMENTS
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * âœ“ VÃ©rification caps.tix et caps.has4S avant toute opÃ©ration
 * âœ“ StratÃ©gie momentum basÃ©e sur forecast (>0.55 long, <0.45 short)
 * âœ“ Position sizing intelligent (max 10% du capital par position)
 * âœ“ Stop-loss et take-profit automatiques
 * âœ“ Backoff exponentiel en cas d'erreurs API rÃ©pÃ©tÃ©es
 * âœ“ Try/catch robuste sur TOUS les appels stock
 * âœ“ MÃ©triques dÃ©taillÃ©es (P&L, win rate, sharpe ratio)
 * âœ“ Tick-based polling (6s par dÃ©faut) au lieu de busy-wait
 * âœ“ Gestion des positions long et short simultanÃ©es
 * âœ“ Logs dÃ©taillÃ©s avec raisons d'achat/vente
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * @usage
 *   ns.run("/managers/stock-manager.js");
 *   // Trade automatiquement sur le marchÃ© boursier
 * 
 * @example
 *   // Mode agressif (position sizing 20%)
 *   // Dans constants.js : CONFIG.STOCK.MAX_POSITION_PERCENT = 0.20
 *   ns.run("/managers/stock-manager.js");
 * 
 * @dependencies
 *   - TIX API (accÃ¨s Ã  la bourse)
 *   - 4S Market Data API (forecast, volatility)
 *   - Minimum capital recommandÃ©: $1B
 */

import { CONFIG } from "/lib/constants.js";
import { Logger } from "/lib/logger.js";
import { Capabilities } from "/lib/capabilities.js";
import { PortHandler } from "/core/port-handler.js";

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * âš™ï¸  CONFIGURATION STOCK TRADING
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
const STOCK_CONFIG = {
    /** Tick interval (6s = cycle du marchÃ©) */
    TICK_INTERVAL: 6000,
    
    /** Pourcentage maximum du capital par position */
    MAX_POSITION_PERCENT: CONFIG.STOCK?.MAX_POSITION_PERCENT || 0.10, // 10%
    
    /** Capital minimum Ã  conserver en rÃ©serve */
    MIN_RESERVE: CONFIG.STOCK?.MIN_RESERVE || 1_000_000_000, // $1B
    
    /** Forecast seuil pour entrer en position LONG */
    LONG_THRESHOLD: CONFIG.STOCK?.LONG_THRESHOLD || 0.55,
    
    /** Forecast seuil pour entrer en position SHORT */
    SHORT_THRESHOLD: CONFIG.STOCK?.SHORT_THRESHOLD || 0.45,
    
    /** Stop-loss: vendre si perte dÃ©passe X% */
    STOP_LOSS_PERCENT: CONFIG.STOCK?.STOP_LOSS_PERCENT || 0.05, // 5%
    
    /** Take-profit: vendre si gain dÃ©passe X% */
    TAKE_PROFIT_PERCENT: CONFIG.STOCK?.TAKE_PROFIT_PERCENT || 0.15, // 15%
    
    /** Commission de la bourse */
    COMMISSION: 100_000,
    
    /** Nombre maximum d'erreurs consÃ©cutives avant backoff */
    MAX_CONSECUTIVE_ERRORS: 5,
    
    /** Backoff initial en cas d'erreur (ms) */
    ERROR_BACKOFF_BASE: 10000 // 10s
};

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ“Š CLASSE POSITION
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ReprÃ©sente une position (long ou short) sur un stock.
 */
class Position {
    constructor(symbol, shares, avgPrice, isLong) {
        this.symbol = symbol;
        this.shares = shares;
        this.avgPrice = avgPrice;
        this.isLong = isLong;
        this.entryTime = Date.now();
    }
    
    getPnL(currentPrice) {
        if (this.isLong) {
            return (currentPrice - this.avgPrice) * this.shares;
        } else {
            return (this.avgPrice - currentPrice) * this.shares;
        }
    }
    
    getPnLPercent(currentPrice) {
        const pnl = this.getPnL(currentPrice);
        const invested = this.avgPrice * this.shares;
        return invested > 0 ? (pnl / invested) : 0;
    }
}

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”§ MAIN FUNCTION
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Boucle principale de trading automatique.
 * 
 * @param {NS} ns - Namespace BitBurner
 */
export async function main(ns) {
    ns.disableLog("ALL");
    
    const log = new Logger(ns, "STOCK-MGR");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ” VÃ‰RIFICATION DES CAPACITÃ‰S
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const caps = new Capabilities(ns);
    
    if (!caps.tix) {
        log.error("TIX API requise (achat WSE account + TIX API Access)");
        ns.tprint("âŒ Ce manager nÃ©cessite l'accÃ¨s Ã  la bourse");
        ns.tprint("   1. Achetez WSE Account ($200M)");
        ns.tprint("   2. Achetez TIX API Access ($5B)");
        return;
    }
    
    if (!caps.has4S) {
        log.warn("âš ï¸  4S Market Data non disponible (trading limitÃ©)");
        log.warn("   Achetez 4S Market Data API ($25B) pour le forecast");
    }
    
    log.success("âœ… TIX API dÃ©tectÃ©e - DÃ©marrage du trading bot");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“Š MÃ‰TRIQUES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const metrics = {
        totalTrades: 0,
        winningTrades: 0,
        losingTrades: 0,
        totalPnL: 0,
        maxDrawdown: 0,
        consecutiveErrors: 0,
        ticksProcessed: 0,
        startTime: Date.now(),
        startingCapital: 0
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ’¼ PORTFOLIO (positions actives)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    /** @type {Map<string, Position>} */
    const portfolio = new Map();
    
    log.info(`âš™ï¸  Configuration:`);
    log.info(`   Tick interval: ${STOCK_CONFIG.TICK_INTERVAL / 1000}s`);
    log.info(`   Max position: ${(STOCK_CONFIG.MAX_POSITION_PERCENT * 100).toFixed(0)}%`);
    log.info(`   Stop-loss: ${(STOCK_CONFIG.STOP_LOSS_PERCENT * 100).toFixed(0)}%`);
    log.info(`   Take-profit: ${(STOCK_CONFIG.TAKE_PROFIT_PERCENT * 100).toFixed(0)}%`);
    log.info(`   4S Data: ${caps.has4S ? 'âœ…' : 'âŒ'}`);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“‹ RÃ‰CUPÃ‰RATION DES SYMBOLES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let symbols = [];
    try {
        symbols = ns.stock.getSymbols();
        log.info(`ğŸ“‹ ${symbols.length} symboles disponibles sur le marchÃ©`);
    } catch (error) {
        log.error(`Impossible de rÃ©cupÃ©rer les symboles: ${error.message}`);
        return;
    }
    
    // Capital de dÃ©part
    metrics.startingCapital = ns.getPlayer().money;
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â™¾ï¸ BOUCLE PRINCIPALE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    while (true) {
        try {
            metrics.ticksProcessed++;
            const player = ns.getPlayer();
            const availableCapital = player.money - STOCK_CONFIG.MIN_RESERVE;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ” SCAN DES POSITIONS EXISTANTES
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            portfolio.clear();
            
            for (const sym of symbols) {
                try {
                    const [longShares, longAvg, shortShares, shortAvg] = ns.stock.getPosition(sym);
                    
                    if (longShares > 0) {
                        portfolio.set(`${sym}-LONG`, new Position(sym, longShares, longAvg, true));
                    }
                    
                    if (shortShares > 0) {
                        portfolio.set(`${sym}-SHORT`, new Position(sym, shortShares, shortAvg, false));
                    }
                } catch (error) {
                    log.error(`Erreur lecture position ${sym}: ${error.message}`);
                    metrics.consecutiveErrors++;
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ“Š GESTION DES POSITIONS EXISTANTES (stop-loss / take-profit)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            for (const [key, position] of portfolio.entries()) {
                try {
                    const currentPrice = ns.stock.getPrice(position.symbol);
                    const pnlPercent = position.getPnLPercent(currentPrice);
                    
                    let shouldClose = false;
                    let reason = "";
                    
                    // Stop-loss
                    if (pnlPercent < -STOCK_CONFIG.STOP_LOSS_PERCENT) {
                        shouldClose = true;
                        reason = `Stop-loss (${(pnlPercent * 100).toFixed(1)}%)`;
                    }
                    
                    // Take-profit
                    if (pnlPercent > STOCK_CONFIG.TAKE_PROFIT_PERCENT) {
                        shouldClose = true;
                        reason = `Take-profit (${(pnlPercent * 100).toFixed(1)}%)`;
                    }
                    
                    // VÃ©rifier le forecast si 4S disponible
                    if (caps.has4S && !shouldClose) {
                        try {
                            const forecast = ns.stock.getForecast(position.symbol);
                            
                            // Si position LONG et forecast < 0.45 â†’ fermer
                            if (position.isLong && forecast < STOCK_CONFIG.SHORT_THRESHOLD) {
                                shouldClose = true;
                                reason = `Forecast bearish (${(forecast * 100).toFixed(1)}%)`;
                            }
                            
                            // Si position SHORT et forecast > 0.55 â†’ fermer
                            if (!position.isLong && forecast > STOCK_CONFIG.LONG_THRESHOLD) {
                                shouldClose = true;
                                reason = `Forecast bullish (${(forecast * 100).toFixed(1)}%)`;
                            }
                        } catch (error) {
                            // getForecast peut Ã©chouer
                        }
                    }
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // ğŸ’° FERMETURE DE POSITION
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    if (shouldClose) {
                        try {
                            let salePrice = 0;
                            
                            if (position.isLong) {
                                salePrice = ns.stock.sellStock(position.symbol, position.shares);
                            } else {
                                salePrice = ns.stock.sellShort(position.symbol, position.shares);
                            }
                            
                            if (salePrice > 0) {
                                const pnl = position.getPnL(salePrice);
                                metrics.totalPnL += pnl;
                                metrics.totalTrades++;
                                
                                if (pnl > 0) {
                                    metrics.winningTrades++;
                                    log.success(`âœ… ${position.symbol} ${position.isLong ? 'LONG' : 'SHORT'} fermÃ©`);
                                } else {
                                    metrics.losingTrades++;
                                    log.warn(`âŒ ${position.symbol} ${position.isLong ? 'LONG' : 'SHORT'} fermÃ©`);
                                }
                                
                                log.info(`   Raison: ${reason}`);
                                log.info(`   P&L: ${ns.formatNumber(pnl)} (${(pnlPercent * 100).toFixed(1)}%)`);
                                
                                metrics.consecutiveErrors = 0; // Reset sur succÃ¨s
                            }
                        } catch (error) {
                            log.error(`Erreur vente ${position.symbol}: ${error.message}`);
                            metrics.consecutiveErrors++;
                        }
                    }
                    
                } catch (error) {
                    log.error(`Erreur gestion position ${position.symbol}: ${error.message}`);
                    metrics.consecutiveErrors++;
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ” RECHERCHE DE NOUVELLES OPPORTUNITÃ‰S
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (availableCapital > 0 && caps.has4S) {
                for (const sym of symbols) {
                    try {
                        // Skip si dÃ©jÃ  en position
                        if (portfolio.has(`${sym}-LONG`) || portfolio.has(`${sym}-SHORT`)) {
                            continue;
                        }
                        
                        const forecast = ns.stock.getForecast(sym);
                        const price = ns.stock.getPrice(sym);
                        const maxShares = ns.stock.getMaxShares(sym);
                        
                        // Calculer le nombre de shares Ã  acheter
                        const maxInvestment = availableCapital * STOCK_CONFIG.MAX_POSITION_PERCENT;
                        const desiredShares = Math.floor(maxInvestment / price);
                        const shares = Math.min(desiredShares, maxShares);
                        
                        // VÃ©rifier que c'est rentable aprÃ¨s commission
                        if (shares * price < STOCK_CONFIG.COMMISSION * 2) {
                            continue;
                        }
                        
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // ğŸ“ˆ OPPORTUNITÃ‰ LONG
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        if (forecast >= STOCK_CONFIG.LONG_THRESHOLD) {
                            try {
                                const buyPrice = ns.stock.buyStock(sym, shares);
                                
                                if (buyPrice > 0) {
                                    log.success(`ğŸ“ˆ ${sym} LONG ouvert`);
                                    log.info(`   Shares: ${ns.formatNumber(shares)}`);
                                    log.info(`   Prix: ${ns.formatNumber(buyPrice)}`);
                                    log.info(`   Forecast: ${(forecast * 100).toFixed(1)}%`);
                                    log.info(`   Investissement: ${ns.formatNumber(shares * buyPrice)}`);
                                    
                                    metrics.consecutiveErrors = 0;
                                }
                            } catch (error) {
                                if (log.debugEnabled) {
                                    log.debug(`Ã‰chec achat ${sym}: ${error.message}`);
                                }
                                metrics.consecutiveErrors++;
                            }
                        }
                        
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // ğŸ“‰ OPPORTUNITÃ‰ SHORT
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        else if (forecast <= STOCK_CONFIG.SHORT_THRESHOLD) {
                            try {
                                const shortPrice = ns.stock.buyShort(sym, shares);
                                
                                if (shortPrice > 0) {
                                    log.success(`ğŸ“‰ ${sym} SHORT ouvert`);
                                    log.info(`   Shares: ${ns.formatNumber(shares)}`);
                                    log.info(`   Prix: ${ns.formatNumber(shortPrice)}`);
                                    log.info(`   Forecast: ${(forecast * 100).toFixed(1)}%`);
                                    log.info(`   Investissement: ${ns.formatNumber(shares * shortPrice)}`);
                                    
                                    metrics.consecutiveErrors = 0;
                                }
                            } catch (error) {
                                if (log.debugEnabled) {
                                    log.debug(`Ã‰chec short ${sym}: ${error.message}`);
                                }
                                metrics.consecutiveErrors++;
                            }
                        }
                        
                    } catch (error) {
                        // Ignorer les erreurs individuelles
                        metrics.consecutiveErrors++;
                    }
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ“Š RAPPORT PÃ‰RIODIQUE (toutes les 50 ticks)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (metrics.ticksProcessed % 50 === 0) {
                const uptime = Date.now() - metrics.startTime;
                const uptimeMin = Math.floor(uptime / 60000);
                const winRate = metrics.totalTrades > 0 
                    ? (metrics.winningTrades / metrics.totalTrades) * 100 
                    : 0;
                const currentCapital = player.money;
                const totalReturn = currentCapital - metrics.startingCapital;
                const returnPercent = metrics.startingCapital > 0
                    ? (totalReturn / metrics.startingCapital) * 100
                    : 0;
                
                log.info(`ğŸ“Š Stats Trading:`);
                log.info(`   Positions: ${portfolio.size} actives`);
                log.info(`   Trades: ${metrics.totalTrades} (${metrics.winningTrades}W/${metrics.losingTrades}L)`);
                log.info(`   Win rate: ${winRate.toFixed(1)}%`);
                log.info(`   P&L total: ${ns.formatNumber(metrics.totalPnL)}`);
                log.info(`   Capital: ${ns.formatNumber(currentCapital)} (${returnPercent > 0 ? '+' : ''}${returnPercent.toFixed(1)}%)`);
                log.info(`   Uptime: ${uptimeMin}min | Ticks: ${metrics.ticksProcessed}`);
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // âš ï¸  GESTION DES ERREURS RÃ‰PÃ‰TÃ‰ES
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (metrics.consecutiveErrors >= STOCK_CONFIG.MAX_CONSECUTIVE_ERRORS) {
                const backoffTime = STOCK_CONFIG.ERROR_BACKOFF_BASE * 
                    Math.pow(2, Math.min(metrics.consecutiveErrors - STOCK_CONFIG.MAX_CONSECUTIVE_ERRORS, 5));
                
                log.warn(`âš ï¸  ${metrics.consecutiveErrors} erreurs consÃ©cutives - backoff ${backoffTime / 1000}s`);
                await ns.sleep(backoffTime);
                metrics.consecutiveErrors = 0; // Reset aprÃ¨s backoff
                continue;
            }
            
        } catch (error) {
            log.error(`Erreur dans la boucle principale: ${error.message}`);
            metrics.consecutiveErrors++;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â±ï¸  SLEEP (tick-based)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        await ns.sleep(STOCK_CONFIG.TICK_INTERVAL);
    }
}
