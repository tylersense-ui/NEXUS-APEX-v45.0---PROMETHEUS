/**
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
 * â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
 * â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•
 *                           v45.0 - "Stealing Fire From The Gods"
 * 
 * @module      managers/gang-manager
 * @description Gestionnaire automatique des Gangs (SF2).
 *              Recrute, Ã©quipe, assigne et ascensionne les membres du gang.
 * @author      Claude (Anthropic) + tylersense-ui
 * @version     45.0 - PROMETHEUS
 * @date        2025-01-XX
 * @license     MIT
 * @requires    BitBurner v2.8.1+ (Steam), Gang API (SF2)
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”¥ PROMETHEUS ENHANCEMENTS
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * âœ“ VÃ©rification caps.gang avant toute opÃ©ration
 * âœ“ Recrutement automatique jusqu'Ã  la limite (12 membres)
 * âœ“ Ã‰quipement intelligent par budget et ROI
 * âœ“ Ascension automatique avec seuil de multiplicateur
 * âœ“ Assignation de tÃ¢ches selon le focus (money, respect, wanted)
 * âœ“ Gestion du territoire et des guerres de gangs
 * âœ“ Rate limiting sur Ã©quipement et ascension
 * âœ“ Try/catch robuste sur TOUTES les opÃ©rations gang
 * âœ“ MÃ©triques dÃ©taillÃ©es (respect, argent, wanted, territoire)
 * âœ“ Logs professionnels avec contexte et progression
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * @usage
 *   ns.run("/managers/gang-manager.js");
 *   // GÃ¨re automatiquement le gang (recrutement, Ã©quipement, tÃ¢ches)
 * 
 * @example
 *   // Mode focus respect (pour dÃ©bloquer des actions)
 *   // Dans constants.js : CONFIG.GANG.FOCUS = "respect"
 *   ns.run("/managers/gang-manager.js");
 */

import { CONFIG } from "/lib/constants.js";
import { Logger } from "/lib/logger.js";
import { Capabilities } from "/lib/capabilities.js";

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * âš™ï¸  CONFIGURATION GANG
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
const GANG_CONFIG = {
    /** Focus principal (money, respect, wanted_reduction, territory) */
    FOCUS: CONFIG.GANG?.FOCUS || "money",
    
    /** Check interval (5s) */
    CHECK_INTERVAL: 5000,
    
    /** Budget minimum pour acheter de l'Ã©quipement */
    MIN_EQUIPMENT_BUDGET: CONFIG.GANG?.MIN_EQUIPMENT_BUDGET || 100_000_000,
    
    /** Seuil de multiplicateur pour ascension (1.5 = +50% de stats) */
    ASCENSION_THRESHOLD: CONFIG.GANG?.ASCENSION_THRESHOLD || 1.5,
    
    /** Enable territoire warfare */
    ENABLE_WARFARE: CONFIG.GANG?.ENABLE_WARFARE ?? true,
    
    /** Territoire minimum avant d'activer warfare (%) */
    MIN_TERRITORY_FOR_WAR: 0.10, // 10%
    
    /** Rate limit: Ã©quipement (1 achat toutes les 10 cycles) */
    EQUIPMENT_RATE_LIMIT: 10,
    
    /** Rate limit: ascension (1 tentative toutes les 100 cycles) */
    ASCENSION_RATE_LIMIT: 100
};

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ¯ TÃ‚CHES PAR FOCUS
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
const TASKS_BY_FOCUS = {
    money: "Human Trafficking", // Max money
    respect: "Terrorism", // Max respect
    wanted_reduction: "Vigilante Justice", // RÃ©duit wanted level
    territory: "Territory Warfare", // ConquÃªte de territoire
    training: "Train Combat" // EntraÃ®nement
};

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”§ MAIN FUNCTION
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Boucle principale de gestion du gang.
 * 
 * @param {NS} ns - Namespace BitBurner
 */
export async function main(ns) {
    ns.disableLog("ALL");
    
    const log = new Logger(ns, "GANG-MGR");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ” VÃ‰RIFICATION DES CAPACITÃ‰S
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const caps = new Capabilities(ns);
    
    if (!caps.gang) {
        log.error("Gang API requise (SF2 + gang crÃ©Ã©)");
        ns.tprint("âŒ Ce manager nÃ©cessite l'API Gang (Source-File 2)");
        ns.tprint("   1. Terminez BitNode 2 pour dÃ©bloquer l'API");
        ns.tprint("   2. CrÃ©ez un gang via Singularity ou manuellement");
        return;
    }
    
    log.success("âœ… Gang API dÃ©tectÃ©e - DÃ©marrage du manager");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“Š MÃ‰TRIQUES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const metrics = {
        membersRecruited: 0,
        equipmentPurchased: 0,
        ascensionsPerformed: 0,
        taskChanges: 0,
        totalRespectGained: 0,
        totalMoneyGained: 0,
        cyclesCompleted: 0,
        startTime: Date.now()
    };
    
    // Rate limiting
    let lastEquipmentCycle = 0;
    let lastAscensionCycle = 0;
    
    log.info(`âš™ï¸  Configuration:`);
    log.info(`   Focus: ${GANG_CONFIG.FOCUS}`);
    log.info(`   Ascension threshold: ${GANG_CONFIG.ASCENSION_THRESHOLD}x`);
    log.info(`   Warfare: ${GANG_CONFIG.ENABLE_WARFARE ? 'âœ…' : 'âŒ'}`);
    log.info(`   Check interval: ${GANG_CONFIG.CHECK_INTERVAL / 1000}s`);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â™¾ï¸ BOUCLE PRINCIPALE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    while (true) {
        try {
            metrics.cyclesCompleted++;
            const player = ns.getPlayer();
            const budget = player.money;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ“Š INFORMATIONS DU GANG
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            let gangInfo = null;
            let members = [];
            
            try {
                gangInfo = ns.gang.getGangInformation();
                members = ns.gang.getMemberNames();
            } catch (error) {
                log.error(`Erreur lecture info gang: ${error.message}`);
                await ns.sleep(GANG_CONFIG.CHECK_INTERVAL);
                continue;
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ‘¥ RECRUTEMENT DE NOUVEAUX MEMBRES
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            try {
                const canRecruit = ns.gang.canRecruitMember();
                
                if (canRecruit && members.length < 12) {
                    const newName = `Member-${members.length + 1}`;
                    const recruited = ns.gang.recruitMember(newName);
                    
                    if (recruited) {
                        metrics.membersRecruited++;
                        log.success(`ğŸ‘¥ Nouveau membre recrutÃ©: ${newName}`);
                        log.info(`   Total membres: ${members.length + 1}/12`);
                    }
                }
            } catch (error) {
                log.error(`Erreur recrutement: ${error.message}`);
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ¯ GESTION DE CHAQUE MEMBRE
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            for (const memberName of members) {
                try {
                    const memberInfo = ns.gang.getMemberInformation(memberName);
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // ğŸ’ª ASCENSION (avec rate limiting)
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    if (metrics.cyclesCompleted - lastAscensionCycle >= GANG_CONFIG.ASCENSION_RATE_LIMIT) {
                        try {
                            const ascensionResult = ns.gang.getAscensionResult(memberName);
                            
                            if (ascensionResult) {
                                // VÃ©rifier si l'ascension est rentable
                                const avgMultiplier = (
                                    ascensionResult.str + 
                                    ascensionResult.def + 
                                    ascensionResult.dex + 
                                    ascensionResult.agi
                                ) / 4;
                                
                                if (avgMultiplier >= GANG_CONFIG.ASCENSION_THRESHOLD) {
                                    const ascended = ns.gang.ascendMember(memberName);
                                    
                                    if (ascended) {
                                        metrics.ascensionsPerformed++;
                                        lastAscensionCycle = metrics.cyclesCompleted;
                                        
                                        log.success(`ğŸ’ª ${memberName} ascensionnÃ©`);
                                        log.info(`   Multiplicateur: ${avgMultiplier.toFixed(2)}x`);
                                    }
                                }
                            }
                        } catch (error) {
                            // getAscensionResult peut retourner null
                        }
                    }
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // ğŸ›¡ï¸  Ã‰QUIPEMENT (avec rate limiting)
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    if (budget > GANG_CONFIG.MIN_EQUIPMENT_BUDGET && 
                        metrics.cyclesCompleted - lastEquipmentCycle >= GANG_CONFIG.EQUIPMENT_RATE_LIMIT) {
                        
                        try {
                            const equipment = ns.gang.getEquipmentNames();
                            
                            for (const equipName of equipment) {
                                // VÃ©rifier si le membre a dÃ©jÃ  cet Ã©quipement
                                if (memberInfo.upgrades.includes(equipName) || 
                                    memberInfo.augmentations.includes(equipName)) {
                                    continue;
                                }
                                
                                const equipCost = ns.gang.getEquipmentCost(equipName);
                                
                                // Acheter si abordable (max 5% du budget)
                                if (equipCost > 0 && equipCost < budget * 0.05) {
                                    try {
                                        const purchased = ns.gang.purchaseEquipment(memberName, equipName);
                                        
                                        if (purchased) {
                                            metrics.equipmentPurchased++;
                                            lastEquipmentCycle = metrics.cyclesCompleted;
                                            
                                            if (log.debugEnabled) {
                                                log.debug(`ğŸ›¡ï¸  ${memberName}: ${equipName} achetÃ© (${ns.formatNumber(equipCost)})`);
                                            }
                                            
                                            break; // Un seul Ã©quipement par cycle par membre
                                        }
                                    } catch (error) {
                                        // Achat peut Ã©chouer
                                    }
                                }
                            }
                        } catch (error) {
                            log.error(`Erreur achat Ã©quipement: ${error.message}`);
                        }
                    }
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // ğŸ¯ ASSIGNATION DE TÃ‚CHE
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    const currentTask = memberInfo.task;
                    let desiredTask = TASKS_BY_FOCUS[GANG_CONFIG.FOCUS] || "Human Trafficking";
                    
                    // Override: si wanted level trop Ã©levÃ©, rÃ©duire
                    if (gangInfo.wantedLevel > 1000) {
                        desiredTask = "Vigilante Justice";
                    }
                    
                    // Override: si membres faibles, entraÃ®ner
                    if (memberInfo.str < 100 || memberInfo.def < 100) {
                        desiredTask = "Train Combat";
                    }
                    
                    if (currentTask !== desiredTask) {
                        try {
                            const assigned = ns.gang.setMemberTask(memberName, desiredTask);
                            
                            if (assigned) {
                                metrics.taskChanges++;
                                
                                if (log.debugEnabled) {
                                    log.debug(`ğŸ¯ ${memberName}: ${currentTask} â†’ ${desiredTask}`);
                                }
                            }
                        } catch (error) {
                            log.error(`Erreur assignation tÃ¢che ${memberName}: ${error.message}`);
                        }
                    }
                    
                } catch (error) {
                    log.error(`Erreur gestion membre ${memberName}: ${error.message}`);
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ—ºï¸  GESTION DU TERRITOIRE
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (GANG_CONFIG.ENABLE_WARFARE) {
                try {
                    const territory = gangInfo.territory;
                    const power = gangInfo.power;
                    
                    // Activer warfare si on a assez de territoire et de puissance
                    if (territory >= GANG_CONFIG.MIN_TERRITORY_FOR_WAR && power > 100) {
                        const currentWarfare = gangInfo.territoryWarfareEngaged;
                        
                        if (!currentWarfare) {
                            ns.gang.setTerritoryWarfare(true);
                            log.info(`ğŸ—ºï¸  Guerre de territoire activÃ©e (${(territory * 100).toFixed(1)}%)`);
                        }
                    } else {
                        // DÃ©sactiver si on est trop faible
                        if (gangInfo.territoryWarfareEngaged && power < 50) {
                            ns.gang.setTerritoryWarfare(false);
                            log.warn(`âš ï¸  Guerre de territoire dÃ©sactivÃ©e (puissance trop faible)`);
                        }
                    }
                } catch (error) {
                    log.error(`Erreur gestion territoire: ${error.message}`);
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ“Š RAPPORT PÃ‰RIODIQUE (toutes les 20 cycles)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (metrics.cyclesCompleted % 20 === 0) {
                const uptime = Date.now() - metrics.startTime;
                const uptimeMin = Math.floor(uptime / 60000);
                
                log.info(`ğŸ“Š Stats Gang:`);
                log.info(`   Faction: ${gangInfo.faction}`);
                log.info(`   Membres: ${members.length}/12`);
                log.info(`   Respect: ${ns.formatNumber(gangInfo.respect)}`);
                log.info(`   Wanted: ${ns.formatNumber(gangInfo.wantedLevel)}`);
                log.info(`   Territoire: ${(gangInfo.territory * 100).toFixed(1)}%`);
                log.info(`   Puissance: ${ns.formatNumber(gangInfo.power)}`);
                log.info(`   Recrues: ${metrics.membersRecruited} | Ã‰quipement: ${metrics.equipmentPurchased}`);
                log.info(`   Ascensions: ${metrics.ascensionsPerformed} | Uptime: ${uptimeMin}min`);
            }
            
        } catch (error) {
            log.error(`Erreur dans la boucle principale: ${error.message}`);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â±ï¸  SLEEP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        await ns.sleep(GANG_CONFIG.CHECK_INTERVAL);
    }
}
