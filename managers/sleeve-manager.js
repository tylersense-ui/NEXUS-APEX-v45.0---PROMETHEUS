/**
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
 * â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
 * â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•
 *                           v45.0 - "Stealing Fire From The Gods"
 * 
 * @module      managers/sleeve-manager
 * @description Gestionnaire automatique des Sleeves (SF10).
 *              Optimise les assignations pour maximize XP, reputation ou argent.
 * @author      Claude (Anthropic) + tylersense-ui
 * @version     45.0 - PROMETHEUS
 * @date        2025-01-XX
 * @license     MIT
 * @requires    BitBurner v2.8.1+ (Steam), Sleeve API (SF10)
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”¥ PROMETHEUS ENHANCEMENTS
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * âœ“ VÃ©rification caps.sleeve avant toute opÃ©ration
 * âœ“ Pacing intelligent par sleeve (Ã©vite spam API)
 * âœ“ Assignations adaptatives selon progression du jeu
 * âœ“ Synchronisation automatique quand disponible
 * âœ“ Achat d'augmentations pour les sleeves avec ROI
 * âœ“ Gestion des crimes, factions, Ã©tudes selon objectifs
 * âœ“ Try/catch robuste sur toutes les opÃ©rations sleeve
 * âœ“ MÃ©triques dÃ©taillÃ©es (XP gagnÃ©, argent gÃ©nÃ©rÃ©, rep farming)
 * âœ“ Rotation des tÃ¢ches pour Ã©quilibrer la progression
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * @usage
 *   ns.run("/managers/sleeve-manager.js");
 *   // GÃ¨re automatiquement tous les sleeves disponibles
 * 
 * @example
 *   // Mode focus argent
 *   // Dans constants.js : CONFIG.SLEEVE.FOCUS = "money"
 *   ns.run("/managers/sleeve-manager.js");
 */

import { CONFIG } from "/lib/constants.js";
import { Logger } from "/lib/logger.js";
import { Capabilities } from "/lib/capabilities.js";

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * âš™ï¸  CONFIGURATION SLEEVE
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
const SLEEVE_CONFIG = {
    /** Focus principal (training, money, faction, crime) */
    FOCUS: CONFIG.SLEEVE?.FOCUS || "training",
    
    /** Check interval par dÃ©faut (10s) */
    CHECK_INTERVAL: 10000,
    
    /** Pacing entre actions sur un mÃªme sleeve (500ms) */
    SLEEVE_ACTION_DELAY: 500,
    
    /** Budget minimum pour acheter des augs de sleeve */
    MIN_AUG_BUDGET: CONFIG.SLEEVE?.MIN_AUG_BUDGET || 1_000_000_000,
    
    /** Synchronisation automatique si disponible */
    AUTO_SYNC: CONFIG.SLEEVE?.AUTO_SYNC ?? true,
    
    /** ROI maximum pour acheter des augs (heures) */
    MAX_AUG_ROI_HOURS: 48
};

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ¯ TÃ‚CHES DISPONIBLES PAR FOCUS
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
const TASKS_BY_FOCUS = {
    training: [
        { type: "gym", stat: "str", location: "Powerhouse Gym" },
        { type: "gym", stat: "def", location: "Powerhouse Gym" },
        { type: "gym", stat: "dex", location: "Powerhouse Gym" },
        { type: "gym", stat: "agi", location: "Powerhouse Gym" },
        { type: "university", course: "Computer Science", location: "Rothman University" }
    ],
    money: [
        { type: "crime", crime: "Heist" },
        { type: "crime", crime: "Homicide" },
        { type: "crime", crime: "Traffick Arms" }
    ],
    faction: [
        { type: "faction", work: "Hacking Contracts" },
        { type: "faction", work: "Field Work" },
        { type: "faction", work: "Security Work" }
    ],
    crime: [
        { type: "crime", crime: "Homicide" },
        { type: "crime", crime: "Mug" },
        { type: "crime", crime: "Assassinate" }
    ]
};

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”§ MAIN FUNCTION
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Boucle principale de gestion des sleeves.
 * 
 * @param {NS} ns - Namespace BitBurner
 */
export async function main(ns) {
    ns.disableLog("ALL");
    
    const log = new Logger(ns, "SLEEVE-MGR");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ” VÃ‰RIFICATION DES CAPACITÃ‰S
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const caps = new Capabilities(ns);
    
    if (!caps.sleeve) {
        log.error("Sleeve API requise (SF10)");
        ns.tprint("âŒ Ce manager nÃ©cessite l'API Sleeve (Source-File 10)");
        ns.tprint("   Terminez BitNode 10 pour dÃ©bloquer cette fonctionnalitÃ©");
        return;
    }
    
    log.success("âœ… Sleeve API dÃ©tectÃ©e - DÃ©marrage du manager");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“Š INITIALISATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let numSleeves = 0;
    try {
        numSleeves = ns.sleeve.getNumSleeves();
    } catch (error) {
        log.error(`Impossible de rÃ©cupÃ©rer le nombre de sleeves: ${error.message}`);
        return;
    }
    
    if (numSleeves === 0) {
        log.warn("Aucun sleeve disponible");
        return;
    }
    
    log.info(`ğŸ­ ${numSleeves} sleeve(s) dÃ©tectÃ©(s)`);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“Š MÃ‰TRIQUES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const metrics = {
        totalMoneyEarned: 0,
        totalXPGained: 0,
        totalRepGained: 0,
        augsInstalled: 0,
        taskChanges: 0,
        syncOperations: 0,
        cyclesCompleted: 0,
        startTime: Date.now()
    };
    
    log.info(`âš™ï¸  Configuration:`);
    log.info(`   Focus: ${SLEEVE_CONFIG.FOCUS}`);
    log.info(`   Auto-sync: ${SLEEVE_CONFIG.AUTO_SYNC ? 'âœ…' : 'âŒ'}`);
    log.info(`   Check interval: ${SLEEVE_CONFIG.CHECK_INTERVAL / 1000}s`);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â™¾ï¸ BOUCLE PRINCIPALE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    while (true) {
        try {
            metrics.cyclesCompleted++;
            const player = ns.getPlayer();
            const budget = player.money;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ­ GESTION DE CHAQUE SLEEVE
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            for (let i = 0; i < numSleeves; i++) {
                try {
                    const sleeve = ns.sleeve.getSleeve(i);
                    const task = ns.sleeve.getTask(i);
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // ğŸ”„ SYNCHRONISATION (si disponible et configurÃ©e)
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    if (SLEEVE_CONFIG.AUTO_SYNC && sleeve.sync < 100) {
                        try {
                            ns.sleeve.setToSynchronize(i);
                            metrics.syncOperations++;
                            
                            if (log.debugEnabled && metrics.cyclesCompleted % 20 === 0) {
                                log.debug(`ğŸ”„ Sleeve ${i} en synchronisation (${sleeve.sync.toFixed(1)}%)`);
                            }
                            
                            await ns.sleep(SLEEVE_CONFIG.SLEEVE_ACTION_DELAY);
                            continue; // Passer au sleeve suivant
                        } catch (error) {
                            // La synchro peut ne pas Ãªtre disponible
                        }
                    }
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // ğŸ’ ACHAT D'AUGMENTATIONS POUR LE SLEEVE
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    if (budget > SLEEVE_CONFIG.MIN_AUG_BUDGET && metrics.cyclesCompleted % 50 === 0) {
                        try {
                            const availableAugs = ns.sleeve.getSleevePurchasableAugs(i);
                            
                            for (const aug of availableAugs) {
                                if (aug.cost > budget - SLEEVE_CONFIG.MIN_AUG_BUDGET) continue;
                                
                                // Calcul ROI approximatif
                                // Une aug coÃ»te X, rapporte Y% de bonus, ROI = X / (bonus_value_per_hour)
                                // SimplifiÃ©: si aug < 10% du budget, on achÃ¨te
                                if (aug.cost < budget * 0.1) {
                                    try {
                                        const purchased = ns.sleeve.purchaseSleeveAug(i, aug.name);
                                        
                                        if (purchased) {
                                            metrics.augsInstalled++;
                                            log.success(`ğŸ’ Sleeve ${i}: aug ${aug.name} installÃ©e`);
                                            log.info(`   CoÃ»t: ${ns.formatNumber(aug.cost)}`);
                                        }
                                    } catch (error) {
                                        // Achat peut Ã©chouer
                                    }
                                    break; // Une seule aug par cycle
                                }
                            }
                        } catch (error) {
                            // getPurchasableAugs peut ne pas Ãªtre disponible
                        }
                    }
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // ğŸ¯ ASSIGNATION DE TÃ‚CHE
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // Si le sleeve n'a pas de tÃ¢che ou si on veut changer
                    const shouldAssignTask = !task || 
                        (metrics.cyclesCompleted % 60 === i * 10); // Rotation staggered
                    
                    if (shouldAssignTask) {
                        const tasks = TASKS_BY_FOCUS[SLEEVE_CONFIG.FOCUS] || TASKS_BY_FOCUS.training;
                        
                        // SÃ©lectionner une tÃ¢che (rotation)
                        const taskIndex = (metrics.cyclesCompleted + i) % tasks.length;
                        const selectedTask = tasks[taskIndex];
                        
                        try {
                            let success = false;
                            
                            if (selectedTask.type === "gym") {
                                success = ns.sleeve.setToGymWorkout(
                                    i, 
                                    selectedTask.location, 
                                    selectedTask.stat
                                );
                            } else if (selectedTask.type === "university") {
                                success = ns.sleeve.setToUniversityCourse(
                                    i,
                                    selectedTask.location,
                                    selectedTask.course
                                );
                            } else if (selectedTask.type === "crime") {
                                success = ns.sleeve.setToCommitCrime(i, selectedTask.crime);
                            } else if (selectedTask.type === "faction") {
                                // Obtenir les factions du joueur
                                const factions = player.factions;
                                if (factions.length > 0) {
                                    // Utiliser la premiÃ¨re faction
                                    success = ns.sleeve.setToFactionWork(
                                        i,
                                        factions[0],
                                        selectedTask.work
                                    );
                                }
                            }
                            
                            if (success) {
                                metrics.taskChanges++;
                                
                                if (log.debugEnabled) {
                                    log.debug(`ğŸ¯ Sleeve ${i}: ${selectedTask.type} assignÃ©`);
                                }
                            }
                        } catch (error) {
                            if (log.debugEnabled) {
                                log.debug(`Erreur assignation sleeve ${i}: ${error.message}`);
                            }
                        }
                    }
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // ğŸ“Š COLLECTE DES STATS (pÃ©riodique)
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    if (metrics.cyclesCompleted % 20 === 0 && i === 0) {
                        // Estimer les gains (approximation)
                        if (task) {
                            if (task.type === "CRIME") {
                                metrics.totalMoneyEarned += 10000; // Estimation
                            }
                        }
                    }
                    
                } catch (error) {
                    log.error(`Erreur lors de la gestion du sleeve ${i}: ${error.message}`);
                }
                
                // Pacing entre les sleeves
                await ns.sleep(SLEEVE_CONFIG.SLEEVE_ACTION_DELAY);
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ“Š RAPPORT PÃ‰RIODIQUE (toutes les 20 cycles)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (metrics.cyclesCompleted % 20 === 0) {
                const uptime = Date.now() - metrics.startTime;
                const uptimeMin = Math.floor(uptime / 60000);
                
                log.info(`ğŸ“Š Stats Sleeves:`);
                log.info(`   Sleeves actifs: ${numSleeves}`);
                log.info(`   Changements de tÃ¢che: ${metrics.taskChanges}`);
                log.info(`   Augs installÃ©es: ${metrics.augsInstalled}`);
                log.info(`   Synchros: ${metrics.syncOperations}`);
                log.info(`   Uptime: ${uptimeMin}min`);
                
                // DÃ©tail de chaque sleeve
                if (log.debugEnabled) {
                    for (let i = 0; i < numSleeves; i++) {
                        try {
                            const sleeve = ns.sleeve.getSleeve(i);
                            const task = ns.sleeve.getTask(i);
                            log.debug(`   Sleeve ${i}: sync=${sleeve.sync.toFixed(1)}% shock=${sleeve.shock.toFixed(1)}%`);
                            if (task) {
                                log.debug(`     Task: ${task.type || 'None'}`);
                            }
                        } catch (error) {
                            // Ignorer les erreurs de dÃ©tail
                        }
                    }
                }
            }
            
        } catch (error) {
            log.error(`Erreur dans la boucle principale: ${error.message}`);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â±ï¸  SLEEP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        await ns.sleep(SLEEVE_CONFIG.CHECK_INTERVAL);
    }
}
