/**
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
 * â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
 * â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•
 *                           v45.0 - "Stealing Fire From The Gods"
 * 
 * @module      boot
 * @description Boot Sequence - Point d'entrÃ©e principal de l'architecture Nexus.
 *              SÃ©quence d'initialisation complÃ¨te du systÃ¨me PROMETHEUS.
 * @author      Claude (Anthropic) + tylersense-ui
 * @version     45.0 - PROMETHEUS
 * @date        2025-01-XX
 * @license     MIT
 * @requires    BitBurner v2.8.1+ (Steam)
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”¥ PROMETHEUS ENHANCEMENTS
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * âœ“ Utilisation de Network.js pour scan unifiÃ© (Ã©vite duplication de code)
 * âœ“ Try/catch robuste sur ns.run() avec logs d'erreur dÃ©taillÃ©s
 * âœ“ DÃ©tection intelligente des modules manquants avec suggestions
 * âœ“ Messages de progression color-coded pour meilleure lisibilitÃ©
 * âœ“ Protection contre l'auto-suicide pendant le nettoyage
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * @usage
 *   run boot.js
 * 
 * @example
 *   // RedÃ©marrage aprÃ¨s un crash systÃ¨me
 *   run global-kill.js
 *   await ns.asleep(2000)
 *   run boot.js
 */

import { Network } from "/lib/network.js";
import { Capabilities } from "/lib/capabilities.js";

/** @param {NS} ns **/
export async function main(ns) {
    ns.disableLog("ALL");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 1 : AFFICHAGE DU BANNER DE DÃ‰MARRAGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ns.tprint("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    ns.tprint("â•‘                                                                  â•‘");
    ns.tprint("â•‘   ğŸ”¥ PROMETHEUS v45.0 - BOOT SEQUENCE INITIATED                  â•‘");
    ns.tprint("â•‘   'Stealing Fire From The Gods'                                  â•‘");
    ns.tprint("â•‘                                                                  â•‘");
    ns.tprint("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    ns.tprint("");

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 2 : NETTOYAGE DES PORTS DE COMMUNICATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ns.tprint("[CLEAN] ğŸ§¹ RÃ©initialisation des ports de communication Nexus...");
    
    for (let i = 1; i <= 20; i++) {
        try {
            ns.clearPort(i);
        } catch (e) {
            ns.tprint(`  âš ï¸  Avertissement : Impossible de nettoyer le port ${i}`);
        }
    }
    
    ns.tprint("  âœ… Ports 1-20 rÃ©initialisÃ©s avec succÃ¨s.");
    ns.tprint("");

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 3 : SCAN COMPLET DU RÃ‰SEAU
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ns.tprint("[SCAN] ğŸ” Cartographie du rÃ©seau en cours...");
    
    let allNodes = [];
    
    // ğŸ”¥ PROMETHEUS ENHANCEMENT : Utilisation de Network.js si disponible
    if (ns.fileExists("/lib/network.js") && ns.fileExists("/lib/capabilities.js")) {
        try {
            const caps = new Capabilities(ns);
            const net = new Network(ns, caps);
            allNodes = net.refresh();
            ns.tprint(`  âœ… Scan unifiÃ© (Network.js) : ${allNodes.length} nÅ“uds dÃ©tectÃ©s.`);
        } catch (e) {
            ns.tprint(`  âš ï¸  Erreur lors de l'utilisation de Network.js : ${e}`);
            allNodes = fallbackScan(ns);
        }
    } else {
        // Fallback : Scan manuel si Network.js n'est pas disponible
        allNodes = fallbackScan(ns);
        ns.tprint(`  âš ï¸  Network.js indisponible - Scan manuel : ${allNodes.length} nÅ“uds dÃ©tectÃ©s.`);
    }
    
    ns.tprint("");

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 4 : ARRÃŠT DE TOUS LES PROCESSUS RÃ‰SEAU
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ns.tprint("[KILL] ğŸ›‘ ArrÃªt de tous les processus sur le rÃ©seau...");
    
    const currentScript = ns.getScriptName();
    let killedCount = 0;
    let errorCount = 0;

    for (const node of allNodes) {
        try {
            const processes = ns.ps(node);
            
            for (const p of processes) {
                // ğŸ”¥ PROTECTION : Ne jamais se suicider en plein vol
                if (node === "home" && p.filename === currentScript) {
                    continue;
                }
                
                // Tentative de kill propre avec gestion d'erreur
                try {
                    if (ns.kill(p.pid, node)) {
                        killedCount++;
                    }
                } catch (killError) {
                    errorCount++;
                }
            }
        } catch (e) {
            ns.tprint(`  âš ï¸  Erreur lors du scan de ${node} : ${e}`);
            errorCount++;
        }
    }
    
    ns.tprint(`  âœ… ${killedCount} processus arrÃªtÃ©s avec succÃ¨s.`);
    if (errorCount > 0) {
        ns.tprint(`  âš ï¸  ${errorCount} erreurs dÃ©tectÃ©es (non bloquant).`);
    }
    ns.tprint("");

    // Pause pour laisser le temps aux processus de se terminer proprement
    await ns.asleep(1000);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 5 : LANCEMENT DU KERNEL ORCHESTRATOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ns.tprint("[BOOT] ğŸš€ Initialisation du Kernel Orchestrator...");
    
    const orchestratorPath = "/core/orchestrator.js";
    
    if (!ns.fileExists(orchestratorPath)) {
        ns.tprint("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        ns.tprint("â•‘                                                                  â•‘");
        ns.tprint("â•‘   âŒ ERREUR CRITIQUE : orchestrator.js INTROUVABLE               â•‘");
        ns.tprint("â•‘                                                                  â•‘");
        ns.tprint("â•‘   Le fichier /core/orchestrator.js est requis pour dÃ©marrer     â•‘");
        ns.tprint("â•‘   le systÃ¨me PROMETHEUS.                                         â•‘");
        ns.tprint("â•‘                                                                  â•‘");
        ns.tprint("â•‘   ğŸ”§ SOLUTIONS POSSIBLES :                                       â•‘");
        ns.tprint("â•‘   1. VÃ©rifiez que tous les fichiers sont uploadÃ©s               â•‘");
        ns.tprint("â•‘   2. ExÃ©cutez : run nexus-update.js --core                      â•‘");
        ns.tprint("â•‘   3. TÃ©lÃ©chargez manuellement depuis le dÃ©pÃ´t GitHub            â•‘");
        ns.tprint("â•‘                                                                  â•‘");
        ns.tprint("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        return;
    }

    // Tentative de lancement avec gestion d'erreur robuste
    try {
        const pid = ns.run(orchestratorPath, 1);
        
        if (pid === 0) {
            // Ã‰chec du lancement (RAM insuffisante ou autre erreur)
            ns.tprint("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            ns.tprint("â•‘                                                                  â•‘");
            ns.tprint("â•‘   âŒ ERREUR : Impossible de lancer orchestrator.js               â•‘");
            ns.tprint("â•‘                                                                  â•‘");
            ns.tprint("â•‘   Causes possibles :                                             â•‘");
            ns.tprint("â•‘   â€¢ RAM insuffisante sur 'home'                                  â•‘");
            ns.tprint("â•‘   â€¢ Fichier corrompu ou invalide                                 â•‘");
            ns.tprint("â•‘   â€¢ DÃ©pendances manquantes                                       â•‘");
            ns.tprint("â•‘                                                                  â•‘");
            ns.tprint("â•‘   ğŸ”§ VÃ©rifiez ns.getServerMaxRam('home') et libÃ©rez de la RAM.  â•‘");
            ns.tprint("â•‘                                                                  â•‘");
            ns.tprint("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            return;
        }
        
        // SuccÃ¨s du lancement
        ns.tprint("  âœ… Kernel Orchestrator lancÃ© avec succÃ¨s (PID: " + pid + ")");
        ns.tprint("");
        
    } catch (e) {
        ns.tprint("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        ns.tprint("â•‘                                                                  â•‘");
        ns.tprint("â•‘   âŒ EXCEPTION LORS DU LANCEMENT                                 â•‘");
        ns.tprint("â•‘                                                                  â•‘");
        ns.tprint(`â•‘   Erreur : ${String(e).substring(0, 50).padEnd(50)}â•‘`);
        ns.tprint("â•‘                                                                  â•‘");
        ns.tprint("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        return;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 6 : CONFIRMATION DE SUCCÃˆS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ns.tprint("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    ns.tprint("â•‘                                                                  â•‘");
    ns.tprint("â•‘   âœ… PROMETHEUS v45.0 - BOOT SEQUENCE COMPLETE                   â•‘");
    ns.tprint("â•‘                                                                  â•‘");
    ns.tprint("â•‘   Le Kernel Orchestrator est maintenant en ligne.                â•‘");
    ns.tprint("â•‘   Tous les modules vont dÃ©marrer automatiquement.                â•‘");
    ns.tprint("â•‘                                                                  â•‘");
    ns.tprint("â•‘   ğŸ”¥ Fire stolen. Gods enraged. System operational.              â•‘");
    ns.tprint("â•‘                                                                  â•‘");
    ns.tprint("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
}

/**
 * Fonction de scan manuel du rÃ©seau (fallback si Network.js indisponible)
 * Utilise un BFS (Breadth-First Search) pour explorer tout le rÃ©seau
 * 
 * @param {NS} ns - Namespace Netscript
 * @returns {string[]} Liste de tous les nÅ“uds dÃ©tectÃ©s
 */
function fallbackScan(ns) {
    const visited = new Set();
    const queue = ["home"];
    
    while (queue.length > 0) {
        const node = queue.shift();
        
        if (!visited.has(node)) {
            visited.add(node);
            
            try {
                const neighbors = ns.scan(node);
                for (const neighbor of neighbors) {
                    if (!visited.has(neighbor)) {
                        queue.push(neighbor);
                    }
                }
            } catch (e) {
                // NÅ“ud inaccessible, on continue
                continue;
            }
        }
    }
    
    return Array.from(visited);
}