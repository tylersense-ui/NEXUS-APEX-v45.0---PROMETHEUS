/**
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
 * â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 * â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
 * â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
 * â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•
 *                           v45.0 - "Stealing Fire From The Gods"
 * 
 * @module      global-kill
 * @description Global Kill - ArrÃªt d'urgence total du systÃ¨me.
 *              Utilitaire d'arrÃªt d'urgence ("panic button") pour PROMETHEUS.
 * @author      Claude (Anthropic) + tylersense-ui
 * @version     45.0 - PROMETHEUS
 * @date        2025-01-XX
 * @license     MIT
 * @requires    BitBurner v2.8.1+ (Steam)
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”¥ PROMETHEUS ENHANCEMENTS
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * âœ“ Utilisation de Network.js pour scan unifiÃ© et optimisÃ©
 * âœ“ Affichage dÃ©taillÃ© du nombre de processus tuÃ©s par serveur
 * âœ“ Gestion robuste des erreurs avec compteurs de succÃ¨s/Ã©chec
 * âœ“ Messages color-coded pour meilleure visibilitÃ©
 * âœ“ Option de confirmation interactive (peut Ãªtre ajoutÃ©e si besoin)
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * @usage
 *   run global-kill.js
 * 
 * @example
 *   // ArrÃªt avant maintenance systÃ¨me
 *   run global-kill.js
 *   // ... effectuer maintenance ...
 *   run boot.js
 * 
 * @warnings
 * âš ï¸  CE SCRIPT EST DESTRUCTIF
 * - Tous les processus en cours seront terminÃ©s immÃ©diatement
 * - Toutes les donnÃ©es en mÃ©moire (non sauvegardÃ©es sur disque) seront perdues
 * - Les batches HWGW en cours seront interrompus
 * - Les ports de communication seront rÃ©initialisÃ©s
 */

import { Network } from "/lib/network.js";
import { Capabilities } from "/lib/capabilities.js";

/** @param {NS} ns **/
export async function main(ns) {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 1 : AFFICHAGE DU BANNER D'AVERTISSEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ns.tprint("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    ns.tprint("â•‘                                                                  â•‘");
    ns.tprint("â•‘   ğŸ›‘ PROMETHEUS v45.0 - GLOBAL KILL INITIATED                    â•‘");
    ns.tprint("â•‘   âš ï¸  ARRÃŠT D'URGENCE TOTAL DU SYSTÃˆME                           â•‘");
    ns.tprint("â•‘                                                                  â•‘");
    ns.tprint("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    ns.tprint("");

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 2 : NETTOYAGE DES PORTS DE COMMUNICATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ns.tprint("[CLEAN] ğŸ§¹ RÃ©initialisation des ports de communication...");
    
    let portsCleared = 0;
    let portsErrors = 0;
    
    for (let i = 1; i <= 20; i++) {
        try {
            ns.clearPort(i);
            portsCleared++;
        } catch (e) {
            portsErrors++;
            ns.tprint(`  âš ï¸  Erreur sur port ${i} : ${e}`);
        }
    }
    
    ns.tprint(`  âœ… ${portsCleared}/20 ports rÃ©initialisÃ©s.`);
    if (portsErrors > 0) {
        ns.tprint(`  âš ï¸  ${portsErrors} erreurs (non bloquant).`);
    }
    ns.tprint("");

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 3 : SCAN COMPLET DU RÃ‰SEAU
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ns.tprint("[SCAN] ğŸ” Cartographie du rÃ©seau en cours...");
    
    let allNodes = [];
    
    // ğŸ”¥ PROMETHEUS ENHANCEMENT : Utilisation de Network.js si disponible
    if (ns.fileExists("/lib/network.js") && ns.fileExists("/lib/capabilities.js")) {
        try {
            const caps = new Capabilities(ns);
            const net = new Network(ns, caps);
            allNodes = net.refresh();
            ns.tprint(`  âœ… Scan unifiÃ© (Network.js) : ${allNodes.length} nÅ“uds dÃ©tectÃ©s.`);
        } catch (e) {
            ns.tprint(`  âš ï¸  Erreur lors de l'utilisation de Network.js : ${e}`);
            allNodes = fallbackScan(ns);
        }
    } else {
        // Fallback : Scan manuel si Network.js n'est pas disponible
        allNodes = fallbackScan(ns);
        ns.tprint(`  âš ï¸  Network.js indisponible - Scan manuel : ${allNodes.length} nÅ“uds dÃ©tectÃ©s.`);
    }
    
    ns.tprint("");

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 4 : ARRÃŠT DE TOUS LES PROCESSUS SUR TOUS LES SERVEURS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ns.tprint("[KILL] ğŸ›‘ ArrÃªt de tous les processus...");
    
    let totalKilled = 0;
    let serversProcessed = 0;
    let serversErrors = 0;

    for (const host of allNodes) {
        try {
            // RÃ©cupÃ©ration de la liste des processus en cours sur ce serveur
            const processes = ns.ps(host);
            const processCount = processes.length;
            
            if (processCount > 0) {
                // Utilisation de ns.killall() pour efficacitÃ© maximale
                const success = ns.killall(host);
                
                if (success) {
                    totalKilled += processCount;
                    serversProcessed++;
                    
                    // Affichage dÃ©taillÃ© pour les serveurs avec beaucoup de processus
                    if (processCount > 10) {
                        ns.tprint(`  ğŸ”¥ ${host.padEnd(20)} â†’ ${processCount} processus arrÃªtÃ©s`);
                    }
                } else {
                    serversErrors++;
                    ns.tprint(`  âš ï¸  Ã‰chec sur ${host} (${processCount} processus)`);
                }
            }
        } catch (e) {
            serversErrors++;
            ns.tprint(`  âŒ Erreur critique sur ${host} : ${e}`);
        }
    }
    
    ns.tprint("");
    ns.tprint(`  âœ… ${totalKilled} processus arrÃªtÃ©s sur ${serversProcessed} serveurs.`);
    if (serversErrors > 0) {
        ns.tprint(`  âš ï¸  ${serversErrors} serveurs avec erreurs (non bloquant).`);
    }
    ns.tprint("");

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ã‰TAPE 5 : CONFIRMATION DE SUCCÃˆS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ns.tprint("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    ns.tprint("â•‘                                                                  â•‘");
    ns.tprint("â•‘   âœ… PROMETHEUS v45.0 - GLOBAL KILL COMPLETE                     â•‘");
    ns.tprint("â•‘                                                                  â•‘");
    ns.tprint("â•‘   Le rÃ©seau est maintenant complÃ¨tement silencieux.              â•‘");
    ns.tprint("â•‘   Tous les processus ont Ã©tÃ© arrÃªtÃ©s avec succÃ¨s.                â•‘");
    ns.tprint("â•‘                                                                  â•‘");
    ns.tprint("â•‘   ğŸ”§ Pour redÃ©marrer le systÃ¨me : run boot.js                    â•‘");
    ns.tprint("â•‘                                                                  â•‘");
    ns.tprint("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
}

/**
 * Fonction de scan manuel du rÃ©seau (fallback si Network.js indisponible)
 * Utilise un BFS (Breadth-First Search) avec gestion d'erreur robuste
 * 
 * @param {NS} ns - Namespace Netscript
 * @returns {string[]} Liste de tous les nÅ“uds dÃ©tectÃ©s
 */
function fallbackScan(ns) {
    const visited = new Set();
    const queue = ["home"];
    
    while (queue.length > 0) {
        const node = queue.shift();
        
        if (!visited.has(node)) {
            visited.add(node);
            
            try {
                const neighbors = ns.scan(node);
                for (const neighbor of neighbors) {
                    if (!visited.has(neighbor)) {
                        queue.push(neighbor);
                    }
                }
            } catch (e) {
                // NÅ“ud inaccessible ou erreur de scan, on continue silencieusement
                continue;
            }
        }
    }
    
    return Array.from(visited);
}